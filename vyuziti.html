<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analýza aktivit strojů • Machine Activity Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #6366f1; background-color: #f5f3ff; }
    th, td { white-space: nowrap; }
    .table-wrap { overflow: auto; }
    .chart-box { position: relative; height: 280px; }
    .chart-box canvas { width: 100% !important; height: 100% !important; }
.table-wrap thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #f8fafc; /* Tailwind: slate-50 */
  box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
}
  </style>
</head>
<body class="bg-gray-50 p-4 font-sans print:p-0">

  <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg p-6 print:shadow-none print:rounded-none print:p-0">

    <header class="flex justify-between items-center pb-4 mb-4 border-b print:hidden">
      <h1 class="text-2xl font-bold text-gray-800">Analýza aktivit strojů <span class="text-gray-400">• Machine Activity Analyzer</span></h1>
      <button id="langSwitch" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition">English</button>
    </header>

    <div id="dropZone" class="dropzone p-8 text-center rounded-lg cursor-pointer transition hover:bg-gray-50 print:hidden">
      <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4v-1a4 4 0 018 0v1a4 4 0 01-4 4zm0 0l-1.5 1.5M7 16h-.5m4 0h.5m-1 0v-.5m0 1v.5M12 4v16m8-8h-8"/>
      </svg>
      <p id="dropText" class="mt-1 text-sm text-gray-600">Přetáhněte sem **XLSX/CSV report** nebo klikněte pro výběr souboru.</p>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden" />
    </div>

    <div id="content" class="hidden">

      <div id="filters" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 print:hidden">

        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Datum od/do</label>
          <div class="flex space-x-2">
            <input type="date" id="dateFrom" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2" />
            <input type="date" id="dateTo" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2" />
          </div>
        </div>

        <div class="space-y-1">
          <label for="shiftFilter" class="block text-sm font-medium text-gray-700">Směna</label>
          <select id="shiftFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
            <option value="all">Všechny směny</option>
            <option value="RANNÍ (06:00-14:00)">RANNÍ (06:00-14:00)</option>
            <option value="ODPOLEDNÍ (14:00-22:00)">ODPOLEDNÍ (14:00-22:00)</option>
            <option value="NOČNÍ (22:00-06:00)">NOČNÍ (22:00-06:00)</option>
          </select>
        </div>

        <div class="space-y-1">
          <label for="warehouseFilter" class="block text-sm font-medium text-gray-700">Sklad/Provoz</label>
          <select id="warehouseFilter" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
            <option value="all">Všechny lokace</option>
            </select>
        </div>

        <div class="space-y-1">
          <label for="groupBy" class="block text-sm font-medium text-gray-700">Seskupit dle</label>
          <select id="groupBy" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
            <option value="machine">Stroj (Flotilní označení)</option>
            <option value="driver">Řidič</option>
            <option value="group">Skupina (Typ stroje)</option>
            <option value="date">Datum</option>
          </select>
        </div>

        <div class="space-y-1">
          <label for="metricSelector" class="block text-sm font-medium text-gray-700">Metrika v tabulce</label>
          <select id="metricSelector" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
            <option value="utilization">Využití (%)</option>
            <option value="keyOnTime">Čas klíče (hod)</option>
            <option value="operationTime">Provozní doba (hod)</option>
            <option value="idleTime">Volnoběh (hod)</option>
            <option value="travelTime">Jízda (hod)</option>
            <option value="liftTime">Zdvih (hod)</option>
            <option value="totalTime">Celkem aktivit (hod)</option>
          </select>
        </div>

        <div class="space-y-1 flex items-end">
          <button id="anomaliesBtn" class="w-full bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600 transition p-2">
            Hledat anomálie
          </button>
        </div>

        <div class="space-y-1 flex items-end col-span-2 space-x-2">
          <button id="exportTableBtn" class="flex-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition p-2">
            Export Tabulky (CSV)
          </button>
          <button id="exportAnomBtn" class="flex-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition p-2">
            Export Anomálií (CSV)
          </button>
          <button id="exportWeeksBtn" class="flex-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600 transition p-2">
            Export Týdenní (CSV)
          </button>
          <button id="printBtn" class="flex-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 transition p-2">
            Tisk / PDF
          </button>
        </div>
      </div>

      <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Grafické shrnutí</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="bg-white p-4 border rounded-lg shadow-sm">
          <h3 id="chart1Title" class="text-lg font-medium text-gray-800 mb-2">Využití podle skupiny (průměr)</h3>
          <div class="chart-box">
            <canvas id="utilizationChart"></canvas>
          </div>
        </div>

        <div class="bg-white p-4 border rounded-lg shadow-sm">
          <h3 id="chart2Title" class="text-lg font-medium text-gray-800 mb-2">Rozklad času všech strojů (celkem)</h3>
          <div class="chart-box">
            <canvas id="timeBreakdownChart"></canvas>
          </div>
        </div>

        <div class="lg:col-span-2 bg-white p-4 border rounded-lg shadow-sm">
          <h3 id="chart3Title" class="text-lg font-medium text-gray-800 mb-2">Hodinová heatmapa aktivit</h3>
          <div class="chart-box" style="height: 400px;">
            <canvas id="heatmapChart"></canvas>
          </div>
        </div>
      </div>

      <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Souhrnná tabulka aktivit</h2>
      <div class="table-wrap bg-white p-4 border rounded-lg shadow-sm">
        <table id="summaryTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="tableHeaderKey">Stroj/Řidič/Skupina</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="tableHeaderMetric">Využití (%)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Počet záznamů</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Čas klíče (hod)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provozní doba (hod)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volnoběh (hod)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jízda (hod)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zdvih (hod)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Celkem (hod)</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
      </div>

      <h2 id="weeklyTitle" class="text-xl font-semibold text-gray-700 mt-8 mb-4">Týdenní přehled (celkové využití)</h2>
      <div id="weeklyTableWrap" class="table-wrap bg-white p-4 border rounded-lg shadow-sm">
        <table id="weeklyTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Týden</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Využití (%)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Počet záznamů</th>
            </tr>
          </thead>
          <tbody id="weeklyTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
      </div>


      <h2 id="anomalyTitle" class="text-xl font-semibold text-gray-700 mt-8 mb-4 hidden">Detekované anomálie</h2>
      <div id="anomalyTableWrap" class="table-wrap bg-white p-4 border rounded-lg shadow-sm hidden">
        <table id="anomalyTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stroj</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Řidič</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Důvod</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Čas klíče (s)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provozní doba (s)</th>
            </tr>
          </thead>
          <tbody id="anomalyTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // =========================================================================================
    // GLOBAL STATE & CONSTANTS
    // =========================================================================================

    const COL_MAP = {
      'cs': {
        'date': 'Datum',
        'machineName': 'Flotilní označení',
        'driverName': 'Řidič',
        'groupName': 'Skupina (Typ)',
        'warehouse': 'Sklad/Provoz',
        'keyOnTime': 'Čas klíče (s)',
        'operationTime': 'Provozní doba (s)',
        'idleTime': 'Volnoběh (s)',
        'travelTime': 'Jízda (s)',
        'liftTime': 'Zdvih (s)',
      },
      'en': {
        'date': 'Date',
        'machineName': 'Fleet Label',
        'driverName': 'Driver',
        'groupName': 'Group (Type)',
        'warehouse': 'Warehouse/Operation',
        'keyOnTime': 'Key-on Time (s)',
        'operationTime': 'Operation Time (s)',
        'idleTime': 'Idle Time (s)',
        'travelTime': 'Travel Time (s)',
        'liftTime': 'Lift Time (s)',
      }
    };

    const state = {
      data: [],
      filteredData: [],
      groupedData: [],
      weekly: [],
      anomalies: [],
      lang: 'cs',
      shiftTimes: {
        'RANNÍ (06:00-14:00)': { start: 6, end: 14 },
        'ODPOLEDNÍ (14:00-22:00)': { start: 14, end: 22 },
        'NOČNÍ (22:00-06:00)': { start: 22, end: 6 } // Night shift crosses midnight
      },
      chartInstances: {}
    };

    // =========================================================================================
    // DOM ELEMENTS
    // =========================================================================================

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropText = document.getElementById('dropText');
    const langSwitch = document.getElementById('langSwitch');
    const contentDiv = document.getElementById('content');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const shiftFilter = document.getElementById('shiftFilter');
    const warehouseFilter = document.getElementById('warehouseFilter');
    const groupBySelect = document.getElementById('groupBy');
    const metricSelector = document.getElementById('metricSelector');
    const summaryTableBody = document.getElementById('summaryTableBody');
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const tableHeaderKey = document.getElementById('tableHeaderKey');
    const tableHeaderMetric = document.getElementById('tableHeaderMetric');
    const anomaliesBtn = document.getElementById('anomaliesBtn');
    const anomalyTitle = document.getElementById('anomalyTitle');
    const anomalyTableWrap = document.getElementById('anomalyTableWrap');
    const anomalyTableBody = document.getElementById('anomalyTableBody');

    // =========================================================================================
    // UTILITY FUNCTIONS
    // =========================================================================================

    /** Converts seconds to hours (formatted string). */
    const toHours = (seconds) => (seconds / 3600).toFixed(2);

    /** Converts seconds to hours (float). */
    const toHoursFloat = (seconds) => seconds / 3600;

    /** Formats a percentage value. */
    const toPercent = (value) => (value).toFixed(1) + '%';

    /** Formats a date string (YYYY-MM-DD) to a more readable format. */
    const formatDate = (dateString, lang) => {
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      const options = lang === 'cs' ? { day: 'numeric', month: 'numeric', year: 'numeric' } : { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString(lang === 'cs' ? 'cs-CZ' : 'en-US', options);
    };

    /** Formats date from YYYY-MM-DD to ISO week format YYYY-W## */
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return d.getUTCFullYear() + '-W' + (weekNo < 10 ? '0' : '') + weekNo;
    };


    /** Calculates the correct shift based on time. */
    const getShift = (date) => {
      const hours = date.getHours();
      // Night shift crosses midnight (22:00 - 05:59)
      if (hours >= 22 || hours < 6) return state.lang === 'cs' ? 'NOČNÍ (22:00-06:00)' : 'NIGHT (22:00-06:00)';
      // Morning shift (06:00 - 13:59)
      if (hours >= 6 && hours < 14) return state.lang === 'cs' ? 'RANNÍ (06:00-14:00)' : 'MORNING (06:00-14:00)';
      // Afternoon shift (14:00 - 21:59)
      if (hours >= 14 && hours < 22) return state.lang === 'cs' ? 'ODPOLEDNÍ (14:00-22:00)' : 'AFTERNOON (14:00-22:00)';
      return state.lang === 'cs' ? 'Neznámá' : 'Unknown';
    };

    /** Translates text using the global COL_MAP. */
    const translate = (key, category = 'cs') => {
      // Direct translation for fixed strings
      const translations = {
        'cs': {
          'Analýza aktivit strojů': 'Machine Activity Analyzer',
          'Přetáhněte sem **XLSX/CSV report** nebo klikněte pro výběr souboru.': 'Drag and drop your **XLSX/CSV report** here, or click to select a file.',
          'Všechny směny': 'All Shifts',
          'Všechny lokace': 'All Locations',
          'RANNÍ (06:00-14:00)': 'MORNING (06:00-14:00)',
          'ODPOLEDNÍ (14:00-22:00)': 'AFTERNOON (14:00-22:00)',
          'NOČNÍ (22:00-06:00)': 'NIGHT (22:00-06:00)',
          'Stroj (Flotilní označení)': 'Machine (Fleet Label)',
          'Řidič': 'Driver',
          'Skupina (Typ stroje)': 'Group (Machine Type)',
          'Datum': 'Date',
          'Využití (%)': 'Utilization (%)',
          'Čas klíče (hod)': 'Key-on Time (hrs)',
          'Provozní doba (hod)': 'Operation Time (hrs)',
          'Volnoběh (hod)': 'Idle Time (hrs)',
          'Jízda (hod)': 'Travel Time (hrs)',
          'Zdvih (hod)': 'Lift Time (hrs)',
          'Celkem aktivit (hod)': 'Total Activity Time (hrs)',
          'Využití podle skupiny (průměr)': 'Utilization by Group (Average)',
          'Rozklad času všech strojů (celkem)': 'Total Time Breakdown for all Machines',
          'Hodinová heatmapa aktivit': 'Hourly Activity Heatmap',
          'Souhrnná tabulka aktivit': 'Summary Table of Activities',
          'Stroj/Řidič/Skupina': 'Machine/Driver/Group',
          'Počet záznamů': 'Record Count',
          'Týdenní přehled (celkové využití)': 'Weekly Overview (Total Utilization)',
          'Týden': 'Week',
          'Detekované anomálie': 'Detected Anomalies',
          'Důvod': 'Reason',
          'Hledat anomálie': 'Find Anomalies',
          'Export Tabulky (CSV)': 'Export Table (CSV)',
          'Export Anomálií (CSV)': 'Export Anomalies (CSV)',
          'Export Týdenní (CSV)': 'Export Weekly (CSV)',
          'Tisk / PDF': 'Print / PDF',
          'Datum od/do': 'Date From/To',
          'Směna': 'Shift',
          'Sklad/Provoz': 'Warehouse/Operation',
          'Seskupit dle': 'Group By',
          'Metrika v tabulce': 'Table Metric',
          'Celkem (hod)': 'Total (hrs)',
          'hod': 'hrs'
        },
        'en': {
          'Analýza aktivit strojů': 'Machine Activity Analyzer',
          'Přetáhněte sem **XLSX/CSV report** nebo klikněte pro výběr souboru.': 'Drag and drop your **XLSX/CSV report** here, or click to select a file.',
          'Všechny směny': 'All Shifts',
          'Všechny lokace': 'All Locations',
          'RANNÍ (06:00-14:00)': 'MORNING (06:00-14:00)',
          'ODPOLEDNÍ (14:00-22:00)': 'AFTERNOON (14:00-22:00)',
          'NOČNÍ (22:00-06:00)': 'NIGHT (22:00-06:00)',
          'Stroj (Flotilní označení)': 'Machine (Fleet Label)',
          'Řidič': 'Driver',
          'Skupina (Typ stroje)': 'Group (Machine Type)',
          'Datum': 'Date',
          'Využití (%)': 'Utilization (%)',
          'Čas klíče (hod)': 'Key-on Time (hrs)',
          'Provozní doba (hod)': 'Operation Time (hrs)',
          'Volnoběh (hod)': 'Idle Time (hrs)',
          'Jízda (hod)': 'Travel Time (hrs)',
          'Zdvih (hod)': 'Lift Time (hrs)',
          'Celkem aktivit (hod)': 'Total Activity Time (hrs)',
          'Využití podle skupiny (průměr)': 'Utilization by Group (Average)',
          'Rozklad času všech strojů (celkem)': 'Total Time Breakdown for all Machines',
          'Hodinová heatmapa aktivit': 'Hourly Activity Heatmap',
          'Souhrnná tabulka aktivit': 'Summary Table of Activities',
          'Stroj/Řidič/Skupina': 'Machine/Driver/Group',
          'Počet záznamů': 'Record Count',
          'Týdenní přehled (celkové využití)': 'Weekly Overview (Total Utilization)',
          'Týden': 'Week',
          'Detekované anomálie': 'Detected Anomalies',
          'Důvod': 'Reason',
          'Hledat anomálie': 'Find Anomalies',
          'Export Tabulky (CSV)': 'Export Table (CSV)',
          'Export Anomálií (CSV)': 'Export Anomalies (CSV)',
          'Export Týdenní (CSV)': 'Export Weekly (CSV)',
          'Tisk / PDF': 'Print / PDF',
          'Datum od/do': 'Date From/To',
          'Směna': 'Shift',
          'Sklad/Provoz': 'Warehouse/Operation',
          'Seskupit dle': 'Group By',
          'Metrika v tabulce': 'Table Metric',
          'Celkem (hod)': 'Total (hrs)',
          'hod': 'hrs'
        }
      };

      if (translations[category] && translations[category][key]) {
        return translations[category][key];
      }
      // Fallback for column names
      return COL_MAP[category][key] || key;
    };

    /** Applies all necessary UI text translations. */
    const applyTranslations = (lang) => {
      // Header
      document.querySelector('header h1').innerHTML = translate('Analýza aktivit strojů') + ` <span class="text-gray-400">• ${translate('Analýza aktivit strojů', 'en')}</span>`;
      langSwitch.textContent = lang === 'cs' ? 'English' : 'Česky';

      // Dropzone
      dropText.innerHTML = translate('Přetáhněte sem **XLSX/CSV report** nebo klikněte pro výběr souboru.');

      // Filters
      document.querySelector('label[for="dateFrom"]').textContent = translate('Datum od/do');
      document.querySelector('label[for="shiftFilter"]').textContent = translate('Směna');
      document.querySelector('option[value="all"]').textContent = translate('Všechny směny');
      document.querySelector('option[value="RANNÍ (06:00-14:00)"]').textContent = translate('RANNÍ (06:00-14:00)');
      document.querySelector('option[value="ODPOLEDNÍ (14:00-22:00)"]').textContent = translate('ODPOLEDNÍ (14:00-22:00)');
      document.querySelector('option[value="NOČNÍ (22:00-06:00)"]').textContent = translate('NOČNÍ (22:00-06:00)');
      document.querySelector('label[for="warehouseFilter"]').textContent = translate('Sklad/Provoz');
      warehouseFilter.querySelector('option[value="all"]').textContent = translate('Všechny lokace');
      document.querySelector('label[for="groupBy"]').textContent = translate('Seskupit dle');
      document.querySelector('option[value="machine"]').textContent = translate('Stroj (Flotilní označení)');
      document.querySelector('option[value="driver"]').textContent = translate('Řidič');
      document.querySelector('option[value="group"]').textContent = translate('Skupina (Typ stroje)');
      document.querySelector('option[value="date"]').textContent = translate('Datum');
      document.querySelector('label[for="metricSelector"]').textContent = translate('Metrika v tabulce');
      metricSelector.querySelector('option[value="utilization"]').textContent = translate('Využití (%)');
      metricSelector.querySelector('option[value="keyOnTime"]').textContent = translate('Čas klíče (hod)');
      metricSelector.querySelector('option[value="operationTime"]').textContent = translate('Provozní doba (hod)');
      metricSelector.querySelector('option[value="idleTime"]').textContent = translate('Volnoběh (hod)');
      metricSelector.querySelector('option[value="travelTime"]').textContent = translate('Jízda (hod)');
      metricSelector.querySelector('option[value="liftTime"]').textContent = translate('Zdvih (hod)');
      metricSelector.querySelector('option[value="totalTime"]').textContent = translate('Celkem aktivit (hod)');
      anomaliesBtn.textContent = translate('Hledat anomálie');
      document.getElementById('exportTableBtn').textContent = translate('Export Tabulky (CSV)');
      document.getElementById('exportAnomBtn').textContent = translate('Export Anomálií (CSV)');
      document.getElementById('exportWeeksBtn').textContent = translate('Export Týdenní (CSV)');
      document.getElementById('printBtn').textContent = translate('Tisk / PDF');

      // Titles
      document.querySelector('h2.text-xl').textContent = translate('Grafické shrnutí');
      document.getElementById('chart1Title').textContent = translate('Využití podle skupiny (průměr)');
      document.getElementById('chart2Title').textContent = translate('Rozklad času všech strojů (celkem)');
      document.getElementById('chart3Title').textContent = translate('Hodinová heatmapa aktivit');
      document.querySelector('h2:nth-of-type(2)').textContent = translate('Souhrnná tabulka aktivit');
      document.getElementById('weeklyTitle').textContent = translate('Týdenní přehled (celkové využití)');
      anomalyTitle.textContent = translate('Detekované anomálie');

      // Table Headers
      tableHeaderKey.textContent = translate('Stroj/Řidič/Skupina');
      updateTableHeaderMetric(); // Updates based on selected metric
      document.querySelector('#summaryTable thead tr th:nth-child(3)').textContent = translate('Počet záznamů');
      document.querySelector('#summaryTable thead tr th:nth-child(4)').textContent = translate('Čas klíče (hod)');
      document.querySelector('#summaryTable thead tr th:nth-child(5)').textContent = translate('Provozní doba (hod)');
      document.querySelector('#summaryTable thead tr th:nth-child(6)').textContent = translate('Volnoběh (hod)');
      document.querySelector('#summaryTable thead tr th:nth-child(7)').textContent = translate('Jízda (hod)');
      document.querySelector('#summaryTable thead tr th:nth-child(8)').textContent = translate('Zdvih (hod)');
      document.querySelector('#summaryTable thead tr th:nth-child(9)').textContent = translate('Celkem (hod)');

      document.querySelector('#weeklyTable thead tr th:nth-child(1)').textContent = translate('Týden');
      document.querySelector('#weeklyTable thead tr th:nth-child(2)').textContent = translate('Využití (%)');
      document.querySelector('#weeklyTable thead tr th:nth-child(3)').textContent = translate('Počet záznamů');

      document.querySelector('#anomalyTable thead tr th:nth-child(1)').textContent = translate(COL_MAP['cs'].date);
      document.querySelector('#anomalyTable thead tr th:nth-child(2)').textContent = translate(COL_MAP['cs'].machineName);
      document.querySelector('#anomalyTable thead tr th:nth-child(3)').textContent = translate(COL_MAP['cs'].driverName);
      document.querySelector('#anomalyTable thead tr th:nth-child(4)').textContent = translate('Důvod');
      document.querySelector('#anomalyTable thead tr th:nth-child(5)').textContent = translate(COL_MAP['cs'].keyOnTime);
      document.querySelector('#anomalyTable thead tr th:nth-child(6)').textContent = translate(COL_MAP['cs'].operationTime);

      // Redraw data to apply language formatting (e.g., date, numbers)
      if (state.data.length > 0) {
        processData();
      }
    };


    // =========================================================================================
    // DATA PROCESSING & FILTERING
    // =========================================================================================

    /** Reads the uploaded XLSX/CSV file. */
    const handleFile = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        let json = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: 'YYYY-MM-DD', header: 1 });

        if (json.length === 0) {
          alert(state.lang === 'cs' ? 'Soubor neobsahuje žádná data.' : 'File contains no data.');
          return;
        }

        // Auto-detect and standardize column headers (case-insensitive, includes translations)
        const headerRow = json.shift();
        const headers = ['date', 'machineName', 'driverName', 'groupName', 'warehouse', 'keyOnTime', 'operationTime', 'idleTime', 'travelTime', 'liftTime'];
        const normalizedHeaders = headers.map(h => COL_MAP['cs'][h]);

        const colIndexMap = {};
        headerRow.forEach((h, i) => {
          const normH = h.toString().trim();
          const targetIndex = normalizedHeaders.findIndex(nh => normH.includes(nh));
          if (targetIndex !== -1) {
            colIndexMap[headers[targetIndex]] = i;
          } else if (normH.includes('Flotilní') || normH.includes('Fleet')) { // Fallback for machine name
            colIndexMap.machineName = i;
          } else if (normH.includes('Řidič') || normH.includes('Driver')) { // Fallback for driver name
            colIndexMap.driverName = i;
          } else if (normH.includes('Datum') || normH.includes('Date')) { // Fallback for date
            colIndexMap.date = i;
          }
        });

        // Validation
        if (!colIndexMap.date || !colIndexMap.machineName || !colIndexMap.keyOnTime) {
          alert(state.lang === 'cs'
            ? 'Chybí klíčové sloupce: Datum, Flotilní označení, Čas klíče (s). Zkontrolujte hlavičku souboru.'
            : 'Missing key columns: Date, Fleet Label, Key-on Time (s). Check your file header.'
          );
          return;
        }

        // Process data rows
        state.data = json.map(row => {
          const dateValue = row[colIndexMap.date];
          const dateObj = new Date(dateValue);
          const time = dateObj.getHours() + dateObj.getMinutes() / 60; // For heatmap
          const machineName = (row[colIndexMap.machineName] || 'Neznámý Stroj').toString().trim();
          const driverName = (row[colIndexMap.driverName] || 'Neznámý Řidič').toString().trim();
          const groupName = (row[colIndexMap.groupName] || 'Neznámá Skupina').toString().trim();
          const warehouse = (row[colIndexMap.warehouse] || 'Neznámá Lokace').toString().trim();

          // Convert all time values to numbers (seconds), fallback to 0
          const getKeyOnTime = () => {
              const val = row[colIndexMap.keyOnTime];
              // Handle Excel date/time format which can sometimes be converted to a float
              if (typeof val === 'number') return Math.round(val * 86400); // Convert Excel days to seconds
              if (typeof val === 'string') return parseFloat(val) || 0;
              return parseInt(val) || 0;
          };

          const keyOnTime = getKeyOnTime();
          const operationTime = parseInt(row[colIndexMap.operationTime]) || 0;
          const idleTime = parseInt(row[colIndexMap.idleTime]) || 0;
          const travelTime = parseInt(row[colIndexMap.travelTime]) || 0;
          const liftTime = parseInt(row[colIndexMap.liftTime]) || 0;

          const totalActivity = idleTime + travelTime + liftTime;
          const utilization = keyOnTime > 0 ? (totalActivity / keyOnTime) * 100 : 0;

          return {
            date: dateValue,
            dateObj,
            time,
            machineName,
            driverName,
            groupName,
            warehouse,
            keyOnTime,
            operationTime,
            idleTime,
            travelTime,
            liftTime,
            totalActivity,
            utilization,
            shift: getShift(dateObj),
            week: getWeekNumber(dateObj)
          };
        }).filter(d => !isNaN(d.dateObj) && d.keyOnTime >= 0); // Filter out invalid date/time entries

        // Setup UI
        setupFilters();
        contentDiv.classList.remove('hidden');
        dropZone.classList.add('hidden');
        processData();
      };

      if (file.type === 'text/csv') {
          // For CSV, read as text to allow encoding auto-detection (though FileReader doesn't do great)
          // We rely on XLSX.js to handle CSV parsing with its worker threads for better encoding support
          reader.readAsArrayBuffer(file);
      } else {
          // For XLSX
          reader.readAsArrayBuffer(file);
      }
    };

    /** Sets initial filter options and values. */
    const setupFilters = () => {
      const dates = state.data.map(d => d.date).filter(Boolean).sort();
      const minDate = dates[0];
      const maxDate = dates[dates.length - 1];

      dateFromInput.value = minDate || '';
      dateToInput.value = maxDate || '';
      dateFromInput.min = minDate || '';
      dateFromInput.max = maxDate || '';
      dateToInput.min = minDate || '';
      dateToInput.max = maxDate || '';

      // Populate warehouse filter options
      const warehouses = [...new Set(state.data.map(d => d.warehouse))].filter(w => w && w !== 'Neznámá Lokace').sort();
      warehouseFilter.innerHTML = `<option value="all">${translate('Všechny lokace')}</option>`;
      warehouses.forEach(w => {
        const option = document.createElement('option');
        option.value = w;
        option.textContent = w;
        warehouseFilter.appendChild(option);
      });
    };

    /** Applies all current filters to the raw data. */
    const filterData = () => {
      let filtered = state.data;
      const dateFrom = dateFromInput.value ? new Date(dateFromInput.value) : null;
      const dateTo = dateToInput.value ? new Date(dateToInput.value) : null;
      const shift = shiftFilter.value;
      const warehouse = warehouseFilter.value;

      filtered = filtered.filter(d => {
        // Date filter
        if (dateFrom && d.dateObj < dateFrom) return false;
        if (dateTo) {
          // Add one day to dateTo to include records from that day
          const dateToInclusive = new Date(dateTo);
          dateToInclusive.setDate(dateToInclusive.getDate() + 1);
          if (d.dateObj >= dateToInclusive) return false;
        }

        // Shift filter
        if (shift !== 'all' && d.shift.includes(shift.split(' (')[0])) return false; // Match start of shift name

        // Warehouse filter
        if (warehouse !== 'all' && d.warehouse !== warehouse) return false;

        return true;
      });

      state.filteredData = filtered;
    };

    /** Groups and aggregates the filtered data. */
    const groupAndAggregateData = () => {
      const key = groupBySelect.value;
      let groupKey;

      if (key === 'machine') groupKey = 'machineName';
      else if (key === 'driver') groupKey = 'driverName';
      else if (key === 'group') groupKey = 'groupName';
      else if (key === 'date') groupKey = 'date';
      else groupKey = 'machineName'; // Default

      const grouped = state.filteredData.reduce((acc, d) => {
        const groupValue = d[groupKey];
        if (!acc[groupValue]) {
          acc[groupValue] = {
            key: groupValue,
            count: 0,
            keyOnTime: 0,
            operationTime: 0,
            idleTime: 0,
            travelTime: 0,
            liftTime: 0,
            totalActivity: 0,
            utilization: 0
          };
        }

        acc[groupValue].count += 1;
        acc[groupValue].keyOnTime += d.keyOnTime;
        acc[groupValue].operationTime += d.operationTime;
        acc[groupValue].idleTime += d.idleTime;
        acc[groupValue].travelTime += d.travelTime;
        acc[groupValue].liftTime += d.liftTime;
        acc[groupValue].totalActivity += d.totalActivity;

        return acc;
      }, {});

      // Calculate final utilization (total activity / total key-on time)
      state.groupedData = Object.values(grouped).map(g => ({
        ...g,
        utilization: g.keyOnTime > 0 ? (g.totalActivity / g.keyOnTime) * 100 : 0
      }));

      // Group for weekly table (only total utilization across all filters)
      const weeklyGrouped = state.filteredData.reduce((acc, d) => {
        const week = d.week;
        if (!acc[week]) {
          acc[week] = { week, count: 0, keyOnTime: 0, totalActivity: 0, utilization: 0 };
        }
        acc[week].count += 1;
        acc[week].keyOnTime += d.keyOnTime;
        acc[week].totalActivity += d.totalActivity;
        return acc;
      }, {});

      state.weekly = Object.values(weeklyGrouped).map(g => ({
        ...g,
        utilization: g.keyOnTime > 0 ? (g.totalActivity / g.keyOnTime) * 100 : 0
      })).sort((a, b) => a.week.localeCompare(b.week));
    };

    /** Main function to process, filter, group, and render data. */
    const processData = () => {
      if (state.data.length === 0) return;

      filterData();
      groupAndAggregateData();

      renderSummaryTable();
      renderWeeklyTable();
      renderCharts();
    };

    // =========================================================================================
    // RENDERING TABLES
    // =========================================================================================

    const updateTableHeaderMetric = () => {
      const metric = metricSelector.value;
      let headerText = translate('Využití (%)');
      if (metric === 'keyOnTime') headerText = translate('Čas klíče (hod)');
      else if (metric === 'operationTime') headerText = translate('Provozní doba (hod)');
      else if (metric === 'idleTime') headerText = translate('Volnoběh (hod)');
      else if (metric === 'travelTime') headerText = translate('Jízda (hod)');
      else if (metric === 'liftTime') headerText = translate('Zdvih (hod)');
      else if (metric === 'totalTime') headerText = translate('Celkem aktivit (hod)');

      tableHeaderMetric.textContent = headerText;
    };

    /** Renders the main summary table. */
    const renderSummaryTable = () => {
      const metric = metricSelector.value;
      summaryTableBody.innerHTML = '';

      state.groupedData.sort((a, b) => {
          let aValue = a.utilization;
          let bValue = b.utilization;

          if (metric === 'keyOnTime') { aValue = a.keyOnTime; bValue = b.keyOnTime; }
          else if (metric === 'operationTime') { aValue = a.operationTime; bValue = b.operationTime; }
          else if (metric === 'idleTime') { aValue = a.idleTime; bValue = b.idleTime; }
          else if (metric === 'travelTime') { aValue = a.travelTime; bValue = b.travelTime; }
          else if (metric === 'liftTime') { aValue = a.liftTime; bValue = b.liftTime; }
          else if (metric === 'totalTime') { aValue = a.totalActivity; bValue = b.totalActivity; }

          return bValue - aValue; // Descending sort
      }).forEach(d => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        let metricValue = d.utilization;
        if (metric === 'keyOnTime') metricValue = toHoursFloat(d.keyOnTime);
        else if (metric === 'operationTime') metricValue = toHoursFloat(d.operationTime);
        else if (metric === 'idleTime') metricValue = toHoursFloat(d.idleTime);
        else if (metric === 'travelTime') metricValue = toHoursFloat(d.travelTime);
        else if (metric === 'liftTime') metricValue = toHoursFloat(d.liftTime);
        else if (metric === 'totalTime') metricValue = toHoursFloat(d.totalActivity);

        let metricDisplay = metric === 'utilization' ? toPercent(metricValue) : metricValue.toFixed(2);

        const cells = [
          d.key,
          metricDisplay,
          d.count.toLocaleString(state.lang === 'cs' ? 'cs-CZ' : 'en-US'),
          toHours(d.keyOnTime),
          toHours(d.operationTime),
          toHours(d.idleTime),
          toHours(d.travelTime),
          toHours(d.liftTime),
          toHours(d.totalActivity)
        ];

        cells.forEach(cellText => {
          const td = document.createElement('td');
          td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
          td.textContent = cellText;
          tr.appendChild(td);
        });
        summaryTableBody.appendChild(tr);
      });
    };

    /** Renders the weekly summary table. */
    const renderWeeklyTable = () => {
      weeklyTableBody.innerHTML = '';

      state.weekly.forEach(d => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        const cells = [
          d.week,
          toPercent(d.utilization),
          d.count.toLocaleString(state.lang === 'cs' ? 'cs-CZ' : 'en-US')
        ];

        cells.forEach(cellText => {
          const td = document.createElement('td');
          td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
          td.textContent = cellText;
          tr.appendChild(td);
        });
        weeklyTableBody.appendChild(tr);
      });
    };

    /** Renders the anomaly table. */
    const renderAnomalyTable = () => {
      anomalyTableBody.innerHTML = '';
      if (state.anomalies.length > 0) {
          anomalyTitle.classList.remove('hidden');
          anomalyTableWrap.classList.remove('hidden');
      } else {
          anomalyTitle.classList.add('hidden');
          anomalyTableWrap.classList.add('hidden');
          return;
      }

      state.anomalies.forEach(d => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 bg-red-50'; // Highlight anomalies

        const cells = [
          formatDate(d.date, state.lang),
          d.machineName,
          d.driverName,
          d.reason,
          d.keyOnTime.toLocaleString(state.lang === 'cs' ? 'cs-CZ' : 'en-US'),
          d.operationTime.toLocaleString(state.lang === 'cs' ? 'cs-CZ' : 'en-US')
        ];

        cells.forEach(cellText => {
          const td = document.createElement('td');
          td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
          td.textContent = cellText;
          tr.appendChild(td);
        });
        anomalyTableBody.appendChild(tr);
      });
    };

    // =========================================================================================
    // RENDERING CHARTS
    // =========================================================================================

    /** Generates a pastel color based on a string seed. */
    const stringToColor = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = 'hsl(' + (hash % 360) + ', 60%, 80%)';
        return color;
    };

    /** Destroys and redraws all charts. */
    const renderCharts = () => {
      // 1. Utilization Chart
      const groupedByGroup = state.groupedData.filter(d => groupBySelect.value === 'group' || d.groupName).reduce((acc, d) => {
        const groupKey = d.groupName || (state.lang === 'cs' ? 'Neznámá Skupina' : 'Unknown Group');
        if (!acc[groupKey]) acc[groupKey] = [];
        acc[groupKey].push(d.utilization);
        return acc;
      }, {});

      const avgUtilizationData = Object.keys(groupedByGroup).map(group => ({
        label: group,
        utilization: groupedByGroup[group].reduce((sum, u) => sum + u, 0) / groupedByGroup[group].length
      })).sort((a, b) => b.utilization - a.utilization);

      renderChart('utilizationChart', 'bar', {
        labels: avgUtilizationData.map(d => d.label),
        datasets: [{
          label: translate('Využití (%)'),
          data: avgUtilizationData.map(d => d.utilization),
          backgroundColor: avgUtilizationData.map(d => stringToColor(d.label)),
          borderColor: avgUtilizationData.map(d => stringToColor(d.label).replace('80%', '50%')),
          borderWidth: 1
        }]
      }, {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: translate('Využití (%)') } },
          x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
        }
      });


      // 2. Time Breakdown Chart (Donut)
      const totalKeyOn = state.filteredData.reduce((sum, d) => sum + d.keyOnTime, 0);
      const totalOperation = state.filteredData.reduce((sum, d) => sum + d.operationTime, 0);
      const totalIdle = state.filteredData.reduce((sum, d) => sum + d.idleTime, 0);
      const totalTravel = state.filteredData.reduce((sum, d) => sum + d.travelTime, 0);
      const totalLift = state.filteredData.reduce((sum, d) => sum + d.liftTime, 0);

      // Remaining time is Key-on - Total Activity (Idle + Travel + Lift)
      const totalActivity = totalIdle + totalTravel + totalLift;
      const remainingKeyOn = Math.max(0, totalKeyOn - totalActivity);
      const totalTime = totalKeyOn + totalOperation; // Use Operation + KeyOn as base for a full picture (if Operation is ever > KeyOn)

      renderChart('timeBreakdownChart', 'doughnut', {
        labels: [
          translate('Provozní doba (hod)'),
          translate('Volnoběh (hod)'),
          translate('Jízda (hod)'),
          translate('Zdvih (hod)'),
          translate('Čas klíče bez aktivity (hod)')
        ],
        datasets: [{
          data: [
            toHoursFloat(totalOperation),
            toHoursFloat(totalIdle),
            toHoursFloat(totalTravel),
            toHoursFloat(totalLift),
            toHoursFloat(remainingKeyOn)
          ],
          backgroundColor: ['#4ade80', '#facc15', '#fb923c', '#e11d48', '#94a3b8'], // green, yellow, orange, red, blue-gray
          hoverOffset: 4
        }]
      }, {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: (tooltipItem) => {
                const total = tooltipItem.dataset.data.reduce((sum, val) => sum + val, 0);
                const value = tooltipItem.raw;
                const percent = total > 0 ? (value / total * 100).toFixed(1) : 0;
                return `${tooltipItem.label}: ${value.toFixed(2)} ${translate('hod')} (${percent}%)`;
              }
            }
          }
        }
      });

      // 3. Hourly Heatmap
      const heatmapData = new Array(24).fill(0).map(() => new Array(7).fill(0)); // 24 hours, 7 days (0=Sun, 6=Sat)

      state.filteredData.forEach(d => {
        const hour = d.dateObj.getHours();
        const day = d.dateObj.getDay(); // 0=Sunday, 1=Monday...
        heatmapData[hour][day] += d.totalActivity; // Sum of activity time
      });

      const maxActivity = heatmapData.flat().reduce((max, val) => Math.max(max, val), 0);
      const heatmapDataset = [];

      for (let hour = 0; hour < 24; hour++) {
        for (let day = 0; day < 7; day++) {
          const totalActivitySec = heatmapData[hour][day];
          const totalActivityHours = toHoursFloat(totalActivitySec);
          heatmapDataset.push({
            x: day,
            y: hour,
            v: totalActivityHours,
            util: maxActivity > 0 ? (totalActivitySec / maxActivity) * 100 : 0 // Relative utilization for color
          });
        }
      }

      const daysOfWeek = [
        state.lang === 'cs' ? 'Ne' : 'Sun',
        state.lang === 'cs' ? 'Po' : 'Mon',
        state.lang === 'cs' ? 'Út' : 'Tue',
        state.lang === 'cs' ? 'St' : 'Wed',
        state.lang === 'cs' ? 'Čt' : 'Thu',
        state.lang === 'cs' ? 'Pá' : 'Fri',
        state.lang === 'cs' ? 'So' : 'Sat',
      ];
      const hoursOfDay = Array.from({ length: 24 }, (_, i) => `${i}:00`);


      renderChart('heatmapChart', 'matrix', {
        datasets: [{
          label: translate('Celková aktivita (hod)'),
          data: heatmapDataset,
          backgroundColor: (context) => {
            if (!context.dataset.data[context.dataIndex]) return 'rgb(243 244 246)'; // gray-100 for zero
            const value = context.dataset.data[context.dataIndex].util;
            const alpha = value / 100;
            // Use a deep blue for activity
            return `rgba(37, 99, 235, ${alpha * 0.8 + 0.2})`; // dark blue
          },
          borderColor: 'white',
          borderWidth: 1,
          hoverBackgroundColor: 'rgba(251, 191, 36, 0.8)', // yellow
          width: ({ chart }) => (chart.chartArea || {}).width / 7 - 1,
          height: ({ chart }) => (chart.chartArea || {}).height / 24 - 1
        }]
      }, {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (tooltipItems) => {
                const item = tooltipItems[0].dataset.data[tooltipItems[0].dataIndex];
                return `${daysOfWeek[item.x]}, ${hoursOfDay[item.y]} - ${hoursOfDay[(item.y + 1) % 24]}`;
              },
              label: (tooltipItem) => {
                const item = tooltipItem.dataset.data[tooltipItem.dataIndex];
                return `${translate('Celkem (hod)')}: ${item.v.toFixed(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'category',
            labels: daysOfWeek,
            grid: { display: false },
            ticks: { padding: 10 }
          },
          y: {
            type: 'category',
            labels: hoursOfDay.reverse(),
            offset: true,
            grid: { display: false },
            ticks: { padding: 5 }
          }
        }
      });
    };

    /** Initializes or updates a Chart.js instance. */
    const renderChart = (canvasId, type, data, options) => {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      if (state.chartInstances[canvasId]) {
        state.chartInstances[canvasId].destroy();
      }

      state.chartInstances[canvasId] = new Chart(canvas, {
        type: type,
        data: data,
        options: options
      });
    };


    // =========================================================================================
    // ANOMALY DETECTION
    // =========================================================================================

    /** Detects simple anomalies based on predefined rules. */
    const detectAnomalies = () => {
      state.anomalies = [];
      const anomalies = [];

      state.filteredData.forEach(d => {
        let reason = null;

        // Rule 1: High Key-on but low Operation (Engine running but not doing much)
        // Key-on > 1 hour (3600s) AND Operation < 10% of Key-on
        if (d.keyOnTime > 3600 && d.operationTime < d.keyOnTime * 0.1) {
          reason = state.lang === 'cs' ? 'Vysoký čas klíče, nízký provoz' : 'High key-on time, low operation';
        }

        // Rule 2: Operation time is much higher than Key-on time (Suggests wrong logging/measurement)
        // Operation > Key-on * 1.5
        if (d.operationTime > d.keyOnTime * 1.5) {
          reason = state.lang === 'cs' ? 'Provozní doba je výrazně vyšší než čas klíče' : 'Operation time significantly higher than key-on time';
        }

        // Rule 3: Very low Key-on but high Idle/Travel/Lift (Activity without Key-on) - less than 5 min Key-on (300s)
        if (d.keyOnTime < 300 && d.totalActivity > 600) {
            reason = state.lang === 'cs' ? 'Vysoká aktivita při nízkém čase klíče' : 'High activity with low key-on time';
        }

        if (reason) {
          anomalies.push({
            date: d.date,
            machineName: d.machineName,
            driverName: d.driverName,
            keyOnTime: d.keyOnTime,
            operationTime: d.operationTime,
            reason: reason,
          });
        }
      });

      state.anomalies = anomalies;
      renderAnomalyTable();

      alert(state.lang === 'cs' ? `Nalezeno ${anomalies.length} anomálií v zobrazených datech.` : `Found ${anomalies.length} anomalies in the displayed data.`);
    };

    // =========================================================================================
    // CSV EXPORT LOGIC
    // =========================================================================================

    /** Converts the summary table data to a CSV string. */
    const toCsvSummary = (data) => {
      if (data.length === 0) return null;

      const lang = state.lang;
      const header = [
        translate('Stroj/Řidič/Skupina'),
        translate('Využití (%)'),
        translate('Počet záznamů'),
        translate('Čas klíče (hod)'),
        translate('Provozní doba (hod)'),
        translate('Volnoběh (hod)'),
        translate('Jízda (hod)'),
        translate('Zdvih (hod)'),
        translate('Celkem (hod)')
      ].join(';');

      const rows = data.map(d => [
        `"${d.key.replace(/"/g, '""')}"`, // Quote keys to handle commas/semicolons
        toPercent(d.utilization).replace('.', ','),
        d.count.toString(),
        toHours(d.keyOnTime).replace('.', ','),
        toHours(d.operationTime).replace('.', ','),
        toHours(d.idleTime).replace('.', ','),
        toHours(d.travelTime).replace('.', ','),
        toHours(d.liftTime).replace('.', ','),
        toHours(d.totalActivity).replace('.', ',')
      ].join(';'));

      return header + '\n' + rows.join('\n');
    };

    /** Converts the anomaly table data to a CSV string. */
    const toCsvAnomalies = (data) => {
      if (data.length === 0) return null;

      const header = [
        translate(COL_MAP['cs'].date),
        translate(COL_MAP['cs'].machineName),
        translate(COL_MAP['cs'].driverName),
        translate('Důvod'),
        translate(COL_MAP['cs'].keyOnTime),
        translate(COL_MAP['cs'].operationTime)
      ].join(';');

      const rows = data.map(d => [
        formatDate(d.date, state.lang),
        `"${d.machineName.replace(/"/g, '""')}"`,
        `"${d.driverName.replace(/"/g, '""')}"`,
        `"${d.reason.replace(/"/g, '""')}"`,
        d.keyOnTime.toString(),
        d.operationTime.toString()
      ].join(';'));

      return header + '\n' + rows.join('\n');
    };

    /** Converts the weekly table data to a CSV string. */
    const toCsvWeeks = (data) => {
        if (data.length === 0) return null;

        const header = [
          translate('Týden'),
          translate('Využití (%)'),
          translate('Počet záznamů')
        ].join(';');

        const rows = data.map(d => [
          d.week,
          toPercent(d.utilization).replace('.', ','),
          d.count.toString()
        ].join(';'));

        return header + '\n' + rows.join('\n');
    };

    // =========================================================================================
    // EVENT LISTENERS
    // =========================================================================================

    // File Dropzone Handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    // Filter Handlers
    dateFromInput.addEventListener('change', processData);
    dateToInput.addEventListener('change', processData);
    shiftFilter.addEventListener('change', processData);
    warehouseFilter.addEventListener('change', processData);
    groupBySelect.addEventListener('change', processData);
    metricSelector.addEventListener('change', () => {
        updateTableHeaderMetric();
        renderSummaryTable();
    });

    // Language Switch
    langSwitch.addEventListener('click', () => {
      state.lang = state.lang === 'cs' ? 'en' : 'cs';
      applyTranslations(state.lang);
    });

    // Anomaly Button Handler
    anomaliesBtn.addEventListener('click', detectAnomalies);

    // Export Button Handlers
    document.getElementById("exportTableBtn").addEventListener("click", () => {
      const csv = toCsvSummary(state.groupedData||[]);
      if(!csv){ alert(state.lang==='cs' ? 'Žádná data k exportu' : 'No data to export'); return; }
      const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"}); // Add BOM for UTF-8 in Excel
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "machine_activity_summary.csv";
      link.click();
      URL.revokeObjectURL(link.href);
    });

    const exportAnomBtn = document.getElementById("exportAnomBtn");
    if(exportAnomBtn){
      exportAnomBtn.addEventListener("click", ()=>{
        const csv = toCsvAnomalies(state.anomalies||[]);
        if(!csv){ alert(state.lang==='cs' ? 'Žádné anomálie' : 'No anomalies'); return; }
        const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_anomalies.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      });
    }

    // Print / PDF export button handler: triggers browser print dialog
    const printBtn = document.getElementById('printBtn');
    if(printBtn){
      printBtn.addEventListener('click', () => {
        window.print();
      });
    }

    const exportWeeksBtn = document.getElementById("exportWeeksBtn");
    if(exportWeeksBtn){
      exportWeeksBtn.addEventListener("click", () => {
        const csv = toCsvWeeks(state.weekly||[]);
        if(!csv){ alert(state.lang==='cs' ? 'Žádná týdenní data' : 'No weekly data'); return; }
        const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_weekly.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      });
    }

    // Initial setup: ensure Czech is the starting language
    document.addEventListener('DOMContentLoaded', () => {
        applyTranslations('cs');
    });

  </script>
</body>
</html>
