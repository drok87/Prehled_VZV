<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analýza aktivit strojů • Machine Activity Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #6366f1; background-color: #f5f3ff; }
    th, td { white-space: nowrap; }
    .table-wrap { overflow: auto; }
    .chart-box { position: relative; height: 280px; }
    .chart-box canvas { width: 100% !important; height: 100% !important; }
.table-wrap thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #f1f5f9; /* Tailwind slate-100 */
}
/* Style for print output */
@media print {
  body {
    background-color: #fff;
    font-size: 10pt;
  }
  .no-print {
    display: none !important;
  }
  .print-header {
    display: block !important;
  }
  .page-break {
    page-break-after: always;
  }
  .chart-box {
    height: 40vh; /* Adjust height for print */
  }
  .print-flex-row {
    display: flex;
    flex-wrap: nowrap;
    justify-content: space-between;
  }
  /* Ensure graph names are visible on print */
  .chart-name {
    display: block;
    text-align: center;
    font-weight: bold;
    margin-top: 10px;
  }
}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="print-header hidden p-4 border-b">
    <h1 class="text-xl font-bold text-center" id="printTitle"></h1>
    <p class="text-center" id="printDateRange"></p>
  </div>


  <div class="container mx-auto p-4 max-w-7xl">
    <div class="flex items-center justify-between mb-6 no-print">
      <h1 class="text-3xl font-extrabold text-indigo-700 select-none">
        <span class="lang-cs">Analýza aktivit strojů</span>
        <span class="lang-en hidden">Machine Activity Analyzer</span>
      </h1>
      <div class="flex space-x-2">
        <select id="languageSelect" class="p-2 border rounded shadow-sm text-sm">
          <option value="cs">Čeština</option>
          <option value="en">English</option>
        </select>
        <button id="printBtn" class="bg-sky-500 hover:bg-sky-600 text-white p-2 rounded shadow-md text-sm transition duration-150 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 2h10m-7 4h4m-1-9V4a1 1 0 00-1-1H7a1 1 0 00-1 1v11"></path>
            </svg>
            <span class="lang-cs">Tisk / PDF</span>
            <span class="lang-en hidden">Print / PDF</span>
        </button>
      </div>
    </div>


    <div id="statusMessage" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
      <p class="font-bold lang-cs">Načítání...</p>
      <p class="font-bold lang-en hidden">Loading...</p>
      <p id="statusText"></p>
    </div>

    <div id="errorMessage" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
      <p class="font-bold lang-cs">Chyba</p>
      <p class="font-bold lang-en hidden">Error</p>
      <p id="errorText"></p>
    </div>

    <div id="warningMessage" class="hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-4" role="alert">
        <p class="font-bold lang-cs">Varování</p>
        <p class="font-bold lang-en hidden">Warning</p>
        <p id="warningText"></p>
    </div>


    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print">

      <div class="bg-white p-4 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-3 border-b pb-2">
          <span class="lang-cs">Nahrání reportu (.xlsx/.csv)</span>
          <span class="lang-en hidden">Report Upload (.xlsx/.csv)</span>
        </h2>
        <div id="dropzone" class="dropzone p-6 text-center rounded-lg cursor-pointer transition duration-150 ease-in-out">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.885 3.37L6 20h12a4 4 0 003.885-4.63L20 16zM12 10l-4 4m0 0l4 4m-4-4h8"></path>
          </svg>
          <p class="mt-2 text-sm text-slate-600">
            <span class="font-medium lang-cs">Přetáhněte soubor sem</span>
            <span class="font-medium lang-en hidden">Drag & Drop file here</span>
            <span class="lang-cs">, nebo klikněte pro výběr.</span>
            <span class="lang-en hidden">, or click to select.</span>
          </p>
          <p class="text-xs text-slate-500 mt-1">
            <span class="lang-cs">Formáty: XLSX, CSV.</span>
            <span class="lang-en hidden">Formats: XLSX, CSV.</span>
          </p>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.csv" class="hidden">
        <p id="fileNameDisplay" class="mt-2 text-sm text-center text-indigo-600 font-medium hidden"></p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-3 border-b pb-2">
          <span class="lang-cs">Filtry</span>
          <span class="lang-en hidden">Filters</span>
        </h2>

        <div class="space-y-3 text-sm">
          <div class="flex space-x-2">
            <div>
              <label for="startDate" class="block font-medium mb-1 lang-cs">Od</label>
              <label for="startDate" class="block font-medium mb-1 lang-en hidden">From</label>
              <input type="date" id="startDate" class="w-full p-2 border rounded shadow-sm">
            </div>
            <div>
              <label for="endDate" class="block font-medium mb-1 lang-cs">Do</label>
              <label for="endDate" class="block font-medium mb-1 lang-en hidden">To</label>
              <input type="date" id="endDate" class="w-full p-2 border rounded shadow-sm">
            </div>
          </div>

          <div>
            <label for="groupingSelect" class="block font-medium mb-1 lang-cs">Seskupit dle</label>
            <label for="groupingSelect" class="block font-medium mb-1 lang-en hidden">Group by</label>
            <select id="groupingSelect" class="w-full p-2 border rounded shadow-sm">
              <option value="machineId" class="lang-cs">Flotilní označení</option>
              <option value="machineId" class="lang-en hidden">Fleet ID</option>
              <option value="machine" class="lang-cs">Stroj</option>
              <option value="machine" class="lang-en hidden">Machine</option>
              <option value="driver" class="lang-cs">Řidič (ID)</option>
              <option value="driver" class="lang-en hidden">Driver (ID)</option>
              <option value="model" class="lang-cs">Model</option>
              <option value="model" class="lang-en hidden">Model</option>
              <option value="day" class="lang-cs">Den (datum)</option>
              <option value="day" class="lang-en hidden">Day (date)</option>
            </select>
          </div>

          <div>
            <label for="shiftFilter" class="block font-medium mb-1 lang-cs">Směna (filtrovat)</label>
            <label for="shiftFilter" class="block font-medium mb-1 lang-en hidden">Shift (filter)</label>
            <select id="shiftFilter" class="w-full p-2 border rounded shadow-sm">
              <option value="all" class="lang-cs">Všechny (A+B+C)</option>
              <option value="all" class="lang-en hidden">All (A+B+C)</option>
              <option value="A" class="lang-cs">Směna A (6:00 - 14:00)</option>
              <option value="A" class="lang-en hidden">Shift A (6:00 - 14:00)</option>
              <option value="B" class="lang-cs">Směna B (14:00 - 22:00)</option>
              <option value="B" class="lang-en hidden">Shift B (14:00 - 22:00)</option>
              <option value="C" class="lang-cs">Směna C (22:00 - 6:00)</option>
              <option value="C" class="lang-en hidden">Shift C (22:00 - 6:00)</option>
            </select>
          </div>

          <div>
            <label for="operationFilter" class="block font-medium mb-1 lang-cs">Provoz / Sklad (filtrovat)</label>
            <label for="operationFilter" class="block font-medium mb-1 lang-en hidden">Operation / Warehouse (filter)</label>
            <select id="operationFilter" class="w-full p-2 border rounded shadow-sm">
              <option value="all" class="lang-cs">Všechny</option>
              <option value="all" class="lang-en hidden">All</option>
            </select>
          </div>

          <div>
            <label for="targetUtilFilter" class="block font-medium mb-1 lang-cs">Cíl využití (%)</label>
            <label for="targetUtilFilter" class="block font-medium mb-1 lang-en hidden">Target Utilization (%)</label>
            <input type="number" id="targetUtilFilter" value="65" min="0" max="100" class="w-full p-2 border rounded shadow-sm text-center">
          </div>
        </div>

        <button id="applyFiltersBtn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
          <span class="lang-cs">Aplikovat filtry</span>
          <span class="lang-en hidden">Apply Filters</span>
        </button>
      </div>

      <div class="bg-white p-4 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-3 border-b pb-2">
          <span class="lang-cs">Legenda a sloupce</span>
          <span class="lang-en hidden">Legend and Columns</span>
        </h2>
        <div class="space-y-2 text-sm">
          <p><strong><span class="lang-cs">Doba klíče</span><span class="lang-en hidden">Key Time</span></strong>: <span class="lang-cs">Celkový čas, kdy byl klíč v zapalování (Stání + Provoz).</span><span class="lang-en hidden">Total time the key was in the ignition (Idle + Operating).</span></p>
          <p><strong><span class="lang-cs">Provozní doba (P)</span><span class="lang-en hidden">Operating Time (O)</span></strong>: <span class="lang-cs">Čas, kdy stroj pracoval (Jízda + Zdvih).</span><span class="lang-en hidden">Time the machine was working (Driving + Lifting).</span></p>
          <p><strong><span class="lang-cs">Využití (%)</span><span class="lang-en hidden">Utilization (%)</span></strong>: **P** / **Doba klíče** <span class="lang-cs">x 100.</span><span class="lang-en hidden">x 100.</span></p>
          <p><strong><span class="lang-cs">Čas jízdy (J)</span><span class="lang-en hidden">Driving Time (D)</span></strong>: <span class="lang-cs">Doba jízdy (v sekundách).</span><span class="lang-en hidden">Driving time (in seconds).</span></p>
          <p><strong><span class="lang-cs">Čas zdvihu (Z)</span><span class="lang-en hidden">Lifting Time (L)</span></strong>: <span class="lang-cs">Doba zdvihu (v sekundách).</span><span class="lang-en hidden">Lifting time (in seconds).</span></p>
          <p><strong><span class="lang-cs">Čas stání (S)</span><span class="lang-en hidden">Idle Time (I)</span></strong>: **Doba klíče** - **P**.</p>
          <p><strong><span class="lang-cs">Čas se zátěží (Zát)</span><span class="lang-en hidden">Loaded Time (Ld)</span></strong>: <span class="lang-cs">Doba, kdy bylo detekováno břemeno.</span><span class="lang-en hidden">Time when a load was detected.</span></p>
          <p><strong><span class="lang-cs">Využití se zát. (%)</span><span class="lang-en hidden">Loaded Util. (%)</span></strong>: **Zát** / **P** <span class="lang-cs">x 100.</span><span class="lang-en hidden">x 100.</span></p>
          <p class="text-red-600 font-bold">
            <span class="lang-cs">POZOR: Nutné sloupce ve vstupu (XLSX):</span>
            <span class="lang-en hidden">ATTENTION: Required columns in the input (XLSX):</span>
          </p>
          <ul class="list-disc list-inside ml-4 text-xs">
            <li>Stroj / Flotilní označení / Řidič / Model / Provoz / Sklad</li>
            <li>Zapnutí stroje / Vypnutí stroje</li>
            <li>Čas klíče (s) / Provozní doba (s) / Čas jízdy (s) / Čas zdvihu (s) / Čas se zátěží (s)</li>
          </ul>
        </div>
      </div>
    </div>


    <div id="content" class="hidden">
      <div class="mb-4 border-b border-gray-200 no-print">
        <ul class="flex flex-wrap -mb-px" id="myTab" role="tablist">
          <li class="mr-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg font-semibold active" id="summary-tab" data-tabs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">
              <span class="lang-cs">Analýza využití</span>
              <span class="lang-en hidden">Utilization Analysis</span>
            </button>
          </li>
          <li class="mr-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg font-semibold" id="comparison-tab" data-tabs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false">
              <span class="lang-cs">Porovnání období</span>
              <span class="lang-en hidden">Period Comparison</span>
            </button>
          </li>
          <li class="mr-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg font-semibold" id="driver-tab" data-tabs-target="#driver" type="button" role="tab" aria-controls="driver" aria-selected="false">
              <span class="lang-cs">Detaily řidičů</span>
              <span class="lang-en hidden">Driver Details</span>
            </button>
          </li>
          <li class="mr-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg font-semibold" id="anomaly-tab" data-tabs-target="#anomaly" type="button" role="tab" aria-controls="anomaly" aria-selected="false">
              <span class="lang-cs">Kontroly a anomálie</span>
              <span class="lang-en hidden">Checks and Anomalies</span>
            </button>
          </li>
        </ul>
      </div>

      <div id="myTabContent">
        <div class="p-4 bg-white rounded-lg shadow-lg active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
          <h2 class="text-2xl font-bold mb-4">
            <span class="lang-cs">Souhrnná analýza (seskupeno dle <span id="groupingTitle">Flotilní označení</span>)</span>
            <span class="lang-en hidden">Summary Analysis (grouped by <span id="groupingTitleEn">Fleet ID</span>)</span>
          </h2>

          <div class="text-right mb-4 no-print">
            <button id="exportSummaryBtn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded shadow-md text-sm transition duration-150 ease-in-out disabled:opacity-50" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H5a2 2 0 01-2-2v-3a2 2 0 012-2h14a2 2 0 012 2v3a2 2 0 01-2 2z"></path>
              </svg>
              <span class="lang-cs">Export (CSV)</span>
              <span class="lang-en hidden">Export (CSV)</span>
            </button>
          </div>

          <div class="table-wrap mb-8">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-slate-100">
                <tr class="text-xs font-medium tracking-wider text-left text-slate-500 uppercase">
                  <th class="p-3">#</th>
                  <th class="p-3" id="tableGroupingHeader">
                    <span class="lang-cs">Flotilní označení</span>
                    <span class="lang-en hidden">Fleet ID</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Doba klíče</span>
                    <span class="lang-en hidden">Key Time</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Provozní doba (P)</span>
                    <span class="lang-en hidden">Operating Time (O)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Využití (%)</span>
                    <span class="lang-en hidden">Utilization (%)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Čas jízdy (J)</span>
                    <span class="lang-en hidden">Driving Time (D)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Čas zdvihu (Z)</span>
                    <span class="lang-en hidden">Lifting Time (L)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Čas stání (S)</span>
                    <span class="lang-en hidden">Idle Time (I)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Čas se zátěží (Zát)</span>
                    <span class="lang-en hidden">Loaded Time (Ld)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Využití se zát. (%)</span>
                    <span class="lang-en hidden">Loaded Util. (%)</span>
                  </th>
                  <th class="p-3 text-right">
                    <span class="lang-cs">Provoz / Sklad</span>
                    <span class="lang-en hidden">Operation / Warehouse</span>
                  </th>
                </tr>
              </thead>
              <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                <tr><td colspan="11" class="text-center p-4 text-slate-500 lang-cs">Nahrajte report a aplikujte filtry.</td><td colspan="11" class="text-center p-4 text-slate-500 lang-en hidden">Upload report and apply filters.</td></tr>
              </tbody>
              <tfoot class="bg-slate-50 font-bold text-base border-t-2 border-slate-300">
                <tr id="summaryTableTotal">
                  </tr>
              </tfoot>
            </table>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-50 p-4 rounded shadow">
              <div class="chart-box">
                <canvas id="utilChart"></canvas>
              </div>
              <p class="chart-name lang-cs">Graf využití (Operating Time / Key Time)</p>
              <p class="chart-name lang-en hidden">Utilization Chart (Operating Time / Key Time)</p>
            </div>
            <div class="bg-slate-50 p-4 rounded shadow">
              <div class="chart-box">
                <canvas id="stackChart"></canvas>
              </div>
              <p class="chart-name lang-cs">Rozklad doby klíče (Stání vs. Provoz)</p>
              <p class="chart-name lang-en hidden">Key Time Breakdown (Idle vs. Operating)</p>
            </div>
          </div>

          <div class="page-break"></div>

          <h3 class="text-xl font-bold mb-4 border-b pb-2">
            <span class="lang-cs">Analýza časového trendu</span>
            <span class="lang-en hidden">Time Trend Analysis</span>
          </h3>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 print-flex-row">
            <div class="bg-slate-50 p-4 rounded shadow">
              <div class="chart-box" style="height: 350px;">
                <canvas id="heatmapChart"></canvas>
              </div>
              <p class="chart-name lang-cs">Hodinová Heatmapa (Průměrné Využití %)</p>
              <p class="chart-name lang-en hidden">Hourly Heatmap (Average Utilization %)</p>
            </div>
            <div class="bg-slate-50 p-4 rounded shadow">
              <div class="chart-box" style="height: 350px;">
                <canvas id="trendChart"></canvas>
              </div>
              <p class="chart-name lang-cs">Denní trend (Průměrné Využití %)</p>
              <p class="chart-name lang-en hidden">Daily Trend (Average Utilization %)</p>
            </div>
          </div>

        </div>


        <div class="p-4 bg-white rounded-lg shadow-lg hidden" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
          <h2 class="text-2xl font-bold mb-4 border-b pb-2">
            <span class="lang-cs">Porovnání období</span>
            <span class="lang-en hidden">Period Comparison</span>
          </h2>
          <p class="mb-4 text-slate-600">
            <span class="lang-cs">Porovnání aktuálně filtrovaného období s předchozím (stejná délka) nebo s konkrétním datem.</span>
            <span class="lang-en hidden">Compare the currently filtered period with the preceding period (same length) or a specific date.</span>
          </p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 no-print">
            <div>
              <label for="comparisonMode" class="block font-medium mb-1 lang-cs">Režim porovnání</label>
              <label for="comparisonMode" class="block font-medium mb-1 lang-en hidden">Comparison Mode</label>
              <select id="comparisonMode" class="w-full p-2 border rounded shadow-sm text-sm">
                <option value="previous" class="lang-cs">Předchozí období (stejná délka)</option>
                <option value="previous" class="lang-en hidden">Previous Period (same length)</option>
                <option value="custom" class="lang-cs">Vlastní datum (Od - Do)</option>
                <option value="custom" class="lang-en hidden">Custom Date Range (From - To)</option>
              </select>
            </div>
            <div id="customDateRangeInputs" class="flex space-x-2 hidden">
              <div>
                <label for="compStartDate" class="block font-medium mb-1 lang-cs">Od</label>
                <label for="compStartDate" class="block font-medium mb-1 lang-en hidden">From</label>
                <input type="date" id="compStartDate" class="w-full p-2 border rounded shadow-sm">
              </div>
              <div>
                <label for="compEndDate" class="block font-medium mb-1 lang-cs">Do</label>
                <label for="compEndDate" class="block font-medium mb-1 lang-en hidden">To</label>
                <input type="date" id="compEndDate" class="w-full p-2 border rounded shadow-sm">
              </div>
            </div>
            <div class="flex items-end">
              <button id="compareBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                <span class="lang-cs">Spustit porovnání</span>
                <span class="lang-en hidden">Run Comparison</span>
              </button>
            </div>
          </div>

          <div id="comparisonResults" class="hidden">
            <p class="text-lg font-bold mb-4">
                <span class="lang-cs">Aktuální období: <span id="currentPeriodRange"></span></span>
                <span class="lang-en hidden">Current Period: <span id="currentPeriodRangeEn"></span></span>
            </p>
            <p class="text-lg font-bold mb-4">
                <span class="lang-cs">Porovnávané období: <span id="compPeriodRange"></span></span>
                <span class="lang-en hidden">Comparison Period: <span id="compPeriodRangeEn"></span></span>
            </p>

            <h3 class="text-xl font-bold mb-4">
                <span class="lang-cs">Přehled využití: <span id="compGroupingTitle">Flotilní označení</span></span>
                <span class="lang-en hidden">Utilization Overview: <span id="compGroupingTitleEn">Fleet ID</span></span>
            </h3>

            <div class="table-wrap mb-8">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-slate-100">
                  <tr class="text-xs font-medium tracking-wider text-left text-slate-500 uppercase">
                    <th class="p-3" id="compTableGroupingHeader">
                      <span class="lang-cs">Flotilní označení</span>
                      <span class="lang-en hidden">Fleet ID</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Využití (%) - Aktuální</span>
                        <span class="lang-en hidden">Util. (%) - Current</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Využití (%) - Porov.</span>
                        <span class="lang-en hidden">Util. (%) - Comp.</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Rozdíl (%)</span>
                        <span class="lang-en hidden">Difference (%)</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Provozní doba (h) - Aktuální</span>
                        <span class="lang-en hidden">Operating Time (h) - Current</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Provozní doba (h) - Porov.</span>
                        <span class="lang-en hidden">Operating Time (h) - Comp.</span>
                    </th>
                    <th class="p-3 text-right">
                        <span class="lang-cs">Rozdíl (h)</span>
                        <span class="lang-en hidden">Difference (h)</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="comparisonTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                  </tbody>
              </table>
            </div>

            <div class="bg-slate-50 p-4 rounded shadow mb-8">
                <div class="chart-box" style="height: 400px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <p class="chart-name lang-cs">Grafické porovnání využití (%)</p>
                <p class="chart-name lang-en hidden">Utilization (%) Comparison Chart</p>
            </div>
          </div>
        </div>


        <div class="p-4 bg-white rounded-lg shadow-lg hidden" id="driver" role="tabpanel" aria-labelledby="driver-tab">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">
                <span class="lang-cs">Detaily řidičů</span>
                <span class="lang-en hidden">Driver Details</span>
            </h2>
            <p class="mb-4 text-slate-600">
                <span class="lang-cs">Přehled využití a aktivity pro jednotlivé řidiče v daném období.</span>
                <span class="lang-en hidden">Overview of utilization and activity for individual drivers in the given period.</span>
            </p>

            <div class="text-right mb-4 no-print">
                <button id="exportDriversBtn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded shadow-md text-sm transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H5a2 2 0 01-2-2v-3a2 2 0 012-2h14a2 2 0 012 2v3a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="lang-cs">Export (CSV)</span>
                    <span class="lang-en hidden">Export (CSV)</span>
                </button>
            </div>

            <div class="table-wrap mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-slate-100">
                      <tr class="text-xs font-medium tracking-wider text-left text-slate-500 uppercase">
                        <th class="p-3">#</th>
                        <th class="p-3">
                          <span class="lang-cs">Řidič (ID)</span>
                          <span class="lang-en hidden">Driver (ID)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Doba klíče</span>
                          <span class="lang-en hidden">Key Time</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Provozní doba (P)</span>
                          <span class="lang-en hidden">Operating Time (O)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Využití (%)</span>
                          <span class="lang-en hidden">Utilization (%)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Čas jízdy (J)</span>
                          <span class="lang-en hidden">Driving Time (D)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Čas zdvihu (Z)</span>
                          <span class="lang-en hidden">Lifting Time (L)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Čas se zátěží (Zát)</span>
                          <span class="lang-en hidden">Loaded Time (Ld)</span>
                        </th>
                        <th class="p-3 text-right">
                          <span class="lang-cs">Počet strojů</span>
                          <span class="lang-en hidden">Number of Machines</span>
                        </th>
                      </tr>
                    </thead>
                    <tbody id="driverDetailsTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                      <tr><td colspan="9" class="text-center p-4 text-slate-500 lang-cs">Nahrajte report a aplikujte filtry.</td><td colspan="9" class="text-center p-4 text-slate-500 lang-en hidden">Upload report and apply filters.</td></tr>
                    </tbody>
                    <tfoot class="bg-slate-50 font-bold text-base border-t-2 border-slate-300">
                        <tr id="driverDetailsTableTotal">
                          </tr>
                    </tfoot>
                </table>
            </div>

            <h3 class="text-xl font-bold mb-4 border-b pb-2">
                <span class="lang-cs">Týdenní přehled - Průměrná Využití dle Řidiče</span>
                <span class="lang-en hidden">Weekly Overview - Average Utilization by Driver</span>
            </h3>
            <div class="bg-slate-50 p-4 rounded shadow mb-8">
              <div class="chart-box" style="height: 450px;">
                <canvas id="weeklyChart"></canvas>
              </div>
              <p class="chart-name lang-cs">Využití (%) dle dne v týdnu pro každého řidiče</p>
              <p class="chart-name lang-en hidden">Utilization (%) by day of the week for each driver</p>
            </div>
        </div>


        <div class="p-4 bg-white rounded-lg shadow-lg hidden" id="anomaly" role="tabpanel" aria-labelledby="anomaly-tab">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">
                <span class="lang-cs">Kontroly a anomálie</span>
                <span class="lang-en hidden">Checks and Anomalies</span>
            </h2>
            <p class="mb-4 text-slate-600">
                <span class="lang-cs">Seznam záznamů, které splňují definovaná kritéria pro kontrolu, jako je extrémně nízké využití.</span>
                <span class="lang-en hidden">A list of records that meet defined check criteria, such as extremely low utilization.</span>
            </p>

            <div class="text-right mb-4 no-print">
                <button id="exportAnomBtn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded shadow-md text-sm transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H5a2 2 0 01-2-2v-3a2 2 0 012-2h14a2 2 0 012 2v3a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="lang-cs">Export anomálií (CSV)</span>
                    <span class="lang-en hidden">Export Anomalies (CSV)</span>
                </button>
            </div>

            <div class="table-wrap mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-slate-100">
                        <tr class="text-xs font-medium tracking-wider text-left text-slate-500 uppercase">
                          <th class="p-3">
                            <span class="lang-cs">Datum</span>
                            <span class="lang-en hidden">Date</span>
                          </th>
                          <th class="p-3">
                            <span class="lang-cs">Stroj / Flotila</span>
                            <span class="lang-en hidden">Machine / Fleet</span>
                          </th>
                          <th class="p-3">
                            <span class="lang-cs">Řidič</span>
                            <span class="lang-en hidden">Driver</span>
                          </th>
                          <th class="p-3 text-right">
                            <span class="lang-cs">Doba klíče</span>
                            <span class="lang-en hidden">Key Time</span>
                          </th>
                          <th class="p-3 text-right">
                            <span class="lang-cs">Provozní doba (P)</span>
                            <span class="lang-en hidden">Operating Time (O)</span>
                          </th>
                          <th class="p-3 text-right">
                            <span class="lang-cs">Využití (%)</span>
                            <span class="lang-en hidden">Utilization (%)</span>
                          </th>
                          <th class="p-3">
                            <span class="lang-cs">Kategorie anomálie</span>
                            <span class="lang-en hidden">Anomaly Category</span>
                          </th>
                        </tr>
                    </thead>
                    <tbody id="anomalyTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="7" class="text-center p-4 text-slate-500 lang-cs">Nahrajte report a aplikujte filtry.</td><td colspan="7" class="text-center p-4 text-slate-500 lang-en hidden">Upload report and apply filters.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </div>

    <footer class="mt-8 pt-4 border-t text-sm text-center text-slate-500 no-print">
        <p>Machine Activity Analyzer &copy; 2024</p>
    </footer>

  </div>


  <script>
    // Constants
    const REQUIRED_COLUMNS = [
      'Stroj', 'Flotilní označení', 'Model', 'Zapnutí stroje', 'Vypnutí stroje',
      'Čas klíče (s)', 'Provozní doba (s)', 'Čas jízdy (s)', 'Čas zdvihu (s)', 'Čas se zátěží (s)', 'Řidič', 'Provoz', 'Sklad'
    ];
    const LANGUAGES = {
        cs: {
            title: "Analýza aktivit strojů",
            groupingOptions: {
                machineId: "Flotilní označení",
                machine: "Stroj",
                driver: "Řidič (ID)",
                model: "Model",
                day: "Den (datum)",
            },
            metricNames: {
                keyTime: "Doba klíče",
                operatingTime: "Provozní doba (P)",
                utilization: "Využití (%)",
                drivingTime: "Čas jízdy (J)",
                liftingTime: "Čas zdvihu (Z)",
                idleTime: "Čas stání (S)",
                loadedTime: "Čas se zátěží (Zát)",
                loadedUtilization: "Využití se zát. (%)",
                driver: "Řidič (ID)",
                operation: "Provoz / Sklad",
                day: "Den",
                weekDay: "Den v týdnu",
                periodComp: "Porov. období",
            },
            shiftNames: {
                all: "Všechny (A+B+C)",
                A: "Směna A (6:00 - 14:00)",
                B: "Směna B (14:00 - 22:00)",
                C: "Směna C (22:00 - 6:00)",
            },
            anomalyCategories: {
                lowUtil: "Nízké využití (<{val}%)",
                shortOpTime: "Krátký provozní čas",
                zeroKeyTime: "Nulová doba klíče",
            },
            timeUnits: {
                h: "h",
                min: "min",
                s: "s",
            },
            messages: {
                fileUploadSuccess: "Soubor **{fileName}** úspěšně načten ({count} záznamů). Nyní aplikujte filtry.",
                missingColumns: "Chybí požadované sloupce: {cols}. Zkontrolujte formát reportu.",
                emptyData: "Nenalezena žádná data nebo záznamy. Zkontrolujte formát souboru a filtry.",
                loading: "Zpracování dat...",
                error: "Vyskytla se neočekávaná chyba při zpracování dat: {error}",
                noOperationData: "Ve vstupním reportu chybí sloupce 'Provoz' a 'Sklad'. Filtr 'Provoz / Sklad' je neaktivní.",
                noAnomaly: "Nenalezena žádná anomálie, která by splňovala kritéria.",
                noComparisonData: "Pro porovnávané období nebyla nalezena žádná data.",
                noWeeklyData: "Nenalezena žádná týdenní data.",
            }
        },
        en: {
            title: "Machine Activity Analyzer",
            groupingOptions: {
                machineId: "Fleet ID",
                machine: "Machine",
                driver: "Driver (ID)",
                model: "Model",
                day: "Day (date)",
            },
            metricNames: {
                keyTime: "Key Time",
                operatingTime: "Operating Time (O)",
                utilization: "Utilization (%)",
                drivingTime: "Driving Time (D)",
                liftingTime: "Lifting Time (L)",
                idleTime: "Idle Time (I)",
                loadedTime: "Loaded Time (Ld)",
                loadedUtilization: "Loaded Util. (%)",
                driver: "Driver (ID)",
                operation: "Operation / Warehouse",
                day: "Day",
                weekDay: "Day of Week",
                periodComp: "Comp. Period",
            },
            shiftNames: {
                all: "All (A+B+C)",
                A: "Shift A (6:00 - 14:00)",
                B: "Shift B (14:00 - 22:00)",
                C: "Shift C (22:00 - 6:00)",
            },
            anomalyCategories: {
                lowUtil: "Low Utilization (<{val}%)",
                shortOpTime: "Short Operating Time",
                zeroKeyTime: "Zero Key Time",
            },
            timeUnits: {
                h: "h",
                min: "min",
                s: "s",
            },
            messages: {
                fileUploadSuccess: "File **{fileName}** successfully loaded ({count} records). Now apply filters.",
                missingColumns: "Missing required columns: {cols}. Check report format.",
                emptyData: "No data or records found. Check file format and filters.",
                loading: "Processing data...",
                error: "An unexpected error occurred during data processing: {error}",
                noOperationData: "The input report is missing 'Provoz' and 'Sklad' columns. 'Operation / Warehouse' filter is inactive.",
                noAnomaly: "No anomalies found meeting the criteria.",
                noComparisonData: "No data found for the comparison period.",
                noWeeklyData: "No weekly data found.",
            }
        }
    };


    // State
    const state = {
      lang: 'cs',
      data: [], // Original raw data from file
      filteredData: [], // Data after filtering (date, shift, operation)
      summary: [], // Aggregated data for summary tab
      drivers: [], // Aggregated data for driver tab
      anomalies: [], // Records flagged as anomalies
      weekly: [], // Weekly aggregated data for chart
      rawHeaders: [], // Headers from the uploaded file
      charts: {}, // Store Chart.js instances
      targetUtilization: 65,
      hasOperationColumn: false,
    };

    // DOM Elements
    const elements = {
      fileInput: document.getElementById('fileInput'),
      dropzone: document.getElementById('dropzone'),
      fileNameDisplay: document.getElementById('fileNameDisplay'),
      statusMessage: document.getElementById('statusMessage'),
      statusText: document.getElementById('statusText'),
      errorMessage: document.getElementById('errorMessage'),
      errorText: document.getElementById('errorText'),
      warningMessage: document.getElementById('warningMessage'),
      warningText: document.getElementById('warningText'),
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      groupingSelect: document.getElementById('groupingSelect'),
      shiftFilter: document.getElementById('shiftFilter'),
      operationFilter: document.getElementById('operationFilter'),
      targetUtilFilter: document.getElementById('targetUtilFilter'),
      applyFiltersBtn: document.getElementById('applyFiltersBtn'),
      summaryTableBody: document.getElementById('summaryTableBody'),
      summaryTableTotal: document.getElementById('summaryTableTotal'),
      groupingTitle: document.getElementById('groupingTitle'),
      groupingTitleEn: document.getElementById('groupingTitleEn'),
      tableGroupingHeader: document.getElementById('tableGroupingHeader'),
      exportSummaryBtn: document.getElementById('exportSummaryBtn'),
      exportDriversBtn: document.getElementById('exportDriversBtn'),
      exportAnomBtn: document.getElementById('exportAnomBtn'),
      content: document.getElementById('content'),
      languageSelect: document.getElementById('languageSelect'),
      printTitle: document.getElementById('printTitle'),
      printDateRange: document.getElementById('printDateRange'),
      printBtn: document.getElementById('printBtn'),

      // Comparison tab elements
      comparisonMode: document.getElementById('comparisonMode'),
      customDateRangeInputs: document.getElementById('customDateRangeInputs'),
      compStartDate: document.getElementById('compStartDate'),
      compEndDate: document.getElementById('compEndDate'),
      compareBtn: document.getElementById('compareBtn'),
      comparisonResults: document.getElementById('comparisonResults'),
      currentPeriodRange: document.getElementById('currentPeriodRange'),
      currentPeriodRangeEn: document.getElementById('currentPeriodRangeEn'),
      compPeriodRange: document.getElementById('compPeriodRange'),
      compPeriodRangeEn: document.getElementById('compPeriodRangeEn'),
      compGroupingTitle: document.getElementById('compGroupingTitle'),
      compGroupingTitleEn: document.getElementById('compGroupingTitleEn'),
      compTableGroupingHeader: document.getElementById('compTableGroupingHeader'),
      comparisonTableBody: document.getElementById('comparisonTableBody'),
    };

    // Helper functions
    const formatTime = (seconds, unit = 'h', lang = 'cs') => {
      if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return '0 s';
      const units = LANGUAGES[lang].timeUnits;
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = Math.round(seconds % 60);

      if (unit === 's') return `${seconds.toLocaleString(lang)} ${units.s}`;
      if (unit === 'min') return `${(seconds / 60).toFixed(1).toLocaleString(lang)} ${units.min}`;
      return `${hours} ${units.h} ${minutes} ${units.min}`;
    };

    const formatSecondsToHours = (seconds, lang = 'cs') => {
        if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return '0.0';
        return (seconds / 3600).toFixed(2).toLocaleString(lang);
    };

    const formatDate = (date, lang = 'cs') => {
        if (!date) return '';
        const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
        return new Date(date).toLocaleDateString(lang, options);
    };

    const formatDecimal = (number, decimals = 2, lang = 'cs') => {
        if (typeof number !== 'number' || isNaN(number)) return '';
        return number.toFixed(decimals).toLocaleString(lang);
    };

    const showMessage = (element, text, isError = false, isWarning = false) => {
      elements.statusMessage.classList.add('hidden');
      elements.errorMessage.classList.add('hidden');
      elements.warningMessage.classList.add('hidden');
      if (text) {
          if (isError) {
              elements.errorText.innerHTML = text;
              elements.errorMessage.classList.remove('hidden');
          } else if (isWarning) {
              elements.warningText.innerHTML = text;
              elements.warningMessage.classList.remove('hidden');
          } else {
              elements.statusText.innerHTML = text;
              elements.statusMessage.classList.remove('hidden');
          }
      }
    };

    const updateUI = () => {
        // Update language based elements
        document.querySelectorAll('.lang-cs').forEach(el => el.classList.toggle('hidden', state.lang !== 'cs'));
        document.querySelectorAll('.lang-en').forEach(el => el.classList.toggle('hidden', state.lang !== 'en'));
        document.querySelector('html').lang = state.lang;
        elements.printTitle.textContent = LANGUAGES[state.lang].title;

        // Update grouping labels
        const currentGrouping = elements.groupingSelect.value;
        const groupingName = LANGUAGES[state.lang].groupingOptions[currentGrouping];
        elements.groupingTitle.textContent = groupingName;
        elements.groupingTitleEn.textContent = groupingName;
        elements.tableGroupingHeader.innerHTML = `<span class="lang-cs">${groupingName}</span><span class="lang-en hidden">${groupingName}</span>`;

        // Update comparison labels
        elements.compGroupingTitle.textContent = groupingName;
        elements.compGroupingTitleEn.textContent = groupingName;
        elements.compTableGroupingHeader.innerHTML = `<span class="lang-cs">${groupingName}</span><span class="lang-en hidden">${groupingName}</span>`;

        // Update shift labels on language change
        const shiftOptions = elements.shiftFilter.options;
        shiftOptions[0].textContent = LANGUAGES[state.lang].shiftNames.all;
        shiftOptions[1].textContent = LANGUAGES[state.lang].shiftNames.A;
        shiftOptions[2].textContent = LANGUAGES[state.lang].shiftNames.B;
        shiftOptions[3].textContent = LANGUAGES[state.lang].shiftNames.C;

        // Re-render data if present
        if (state.summary.length > 0) {
            renderSummaryTable();
            renderCharts();
        }
        if (state.drivers.length > 0) {
            renderDriverDetailsTable();
            renderWeeklyChart();
        }
        if (state.anomalies.length > 0) {
            renderAnomalyTable();
        }
    };

    // Time conversion and calculation logic
    const getShift = (time) => {
      const date = new Date(time);
      const hours = date.getHours();
      // A: 6:00 - 14:00
      if (hours >= 6 && hours < 14) return 'A';
      // B: 14:00 - 22:00
      if (hours >= 14 && hours < 22) return 'B';
      // C: 22:00 - 6:00 (covers 22:00 to 23:59 and 00:00 to 05:59)
      if (hours >= 22 || hours < 6) return 'C';
      return 'Unknown';
    };

    const getWeekDay = (time) => {
        const date = new Date(time);
        // getDay() returns 0 for Sunday, 1 for Monday, ..., 6 for Saturday
        // Map to 1 (Mon) to 7 (Sun)
        return (date.getDay() === 0 ? 7 : date.getDay());
    };

    const calculateMetrics = (data) => {
      const operatingTime = data['Provozní doba (s)'] || 0;
      const keyTime = data['Čas klíče (s)'] || 0;
      const loadedTime = data['Čas se zátěží (s)'] || 0;

      const metrics = {
        keyTime,
        operatingTime,
        drivingTime: data['Čas jízdy (s)'] || 0,
        liftingTime: data['Čas zdvihu (s)'] || 0,
        idleTime: Math.max(0, keyTime - operatingTime), // Idle = Key - Operating
        loadedTime,
        utilization: keyTime > 0 ? (operatingTime / keyTime) * 100 : 0,
        loadedUtilization: operatingTime > 0 ? (loadedTime / operatingTime) * 100 : 0,
      };
      return metrics;
    };


    // --- File Reading and Parsing ---
    const readFile = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            let workbook;
            if (file.name.endsWith('.xlsx')) {
                workbook = XLSX.read(data, { type: 'array', cellDates: true });
            } else if (file.name.endsWith('.csv')) {
                const text = new TextDecoder('utf-8').decode(data);
                workbook = XLSX.read(text, { type: 'string', raw: true });
            } else {
                throw new Error('Unsupported file type.');
            }

            // Assume the first sheet is the one containing the data
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            // Convert sheet to JSON array
            const json = XLSX.utils.sheet_to_json(sheet, {
              raw: false, // Keep dates formatted
              dateNF: 'yyyy-mm-dd hh:mm:ss' // Standard date format for parsing
            });

            // Extract headers
            const headers = XLSX.utils.sheet_to_json(sheet, { header: 1 })[0];

            resolve({ json, headers });
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = (error) => reject(error);
        reader.readAsArrayBuffer(file);
      });
    };

    const validateAndCleanData = (rawData, rawHeaders) => {
        // 1. Check for required columns
        const missingCols = REQUIRED_COLUMNS.filter(col => !rawHeaders.includes(col));
        if (missingCols.length > 0) {
            const msg = LANGUAGES[state.lang].messages.missingColumns.replace('{cols}', missingCols.join(', '));
            showMessage(elements.errorMessage, msg, true);
            throw new Error(msg);
        }

        // 2. Check for Provoz/Sklad
        state.hasOperationColumn = rawHeaders.includes('Provoz') || rawHeaders.includes('Sklad');
        if (!state.hasOperationColumn) {
            const msg = LANGUAGES[state.lang].messages.noOperationData;
            showMessage(elements.warningMessage, msg, false, true);
            elements.operationFilter.disabled = true;
        } else {
            elements.operationFilter.disabled = false;
        }

        // 3. Process records
        const processedData = rawData.map(row => {
            const keyTime = parseFloat(row['Čas klíče (s)']) || 0;
            const operatingTime = parseFloat(row['Provozní doba (s)']) || 0;
            const drivingTime = parseFloat(row['Čas jízdy (s)']) || 0;
            const liftingTime = parseFloat(row['Čas zdvihu (s)']) || 0;
            const loadedTime = parseFloat(row['Čas se zátěží (s)']) || 0;
            const machineId = row['Flotilní označení'] || 'N/A';
            const machine = row['Stroj'] || 'N/A';
            const driver = row['Řidič'] || 'N/A';
            const model = row['Model'] || 'N/A';
            const startDateString = row['Zapnutí stroje'];
            const endDateString = row['Vypnutí stroje'];

            // Parse Date
            const startTime = startDateString ? new Date(startDateString) : null;
            const endTime = endDateString ? new Date(endDateString) : null;
            const isValid = startTime && endTime && startTime.getTime() < endTime.getTime() && keyTime > 0;

            let dateOnly = null;
            let hourOnly = null;
            let shift = 'Unknown';
            let weekDay = null;

            if (startTime) {
                dateOnly = startTime.toISOString().split('T')[0]; // YYYY-MM-DD
                hourOnly = startTime.getHours();
                shift = getShift(startTime);
                weekDay = getWeekDay(startTime);
            }

            // Determine Operation/Warehouse
            let operation = row['Provoz'] || row['Sklad'] || 'N/A';
            if (operation === 'N/A' && state.hasOperationColumn) {
                // If one exists but the other is empty, we must keep N/A
                operation = 'N/A';
            } else if (!state.hasOperationColumn) {
                operation = 'All'; // Special value for filtering when columns are missing
            }


            return {
                // ID fields
                machineId,
                machine,
                driver,
                model,
                operation, // Operation or Sklad
                // Time fields
                startTime,
                endTime,
                dateOnly,
                hourOnly,
                shift,
                weekDay,
                // Metric fields (converted to number)
                'Čas klíče (s)': keyTime,
                'Provozní doba (s)': operatingTime,
                'Čas jízdy (s)': drivingTime,
                'Čas zdvihu (s)': liftingTime,
                'Čas se zátěží (s)': loadedTime,
                // Calculated metrics (recalculated later)
                ...calculateMetrics({
                    'Čas klíče (s)': keyTime,
                    'Provozní doba (s)': operatingTime,
                    'Čas jízdy (s)': drivingTime,
                    'Čas zdvihu (s)': liftingTime,
                    'Čas se zátěží (s)': loadedTime,
                }),
                // Validity flag
                isValid
            };
        }).filter(row => row.isValid); // Only keep valid records

        if (processedData.length === 0) {
            const msg = LANGUAGES[state.lang].messages.emptyData;
            showMessage(elements.errorMessage, msg, true);
            throw new Error(msg);
        }

        // 4. Set date range defaults based on data
        const dates = processedData.map(row => new Date(row.dateOnly).getTime()).filter(t => !isNaN(t));
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));

        elements.startDate.value = minDate.toISOString().split('T')[0];
        elements.endDate.value = maxDate.toISOString().split('T')[0];

        // 5. Populate Operation Filter
        if (state.hasOperationColumn) {
            const operations = [...new Set(processedData.map(row => row.operation))].filter(op => op !== 'N/A').sort();
            elements.operationFilter.innerHTML = `
                <option value="all" class="lang-cs">${LANGUAGES.cs.shiftNames.all}</option>
                <option value="all" class="lang-en hidden">${LANGUAGES.en.shiftNames.all}</option>
                ${operations.map(op => `<option value="${op}">${op}</option>`).join('')}
                <option value="N/A">N/A</option>
            `;
        }

        return processedData;
    };

    const handleFile = async (file) => {
      try {
        showMessage(elements.statusMessage, LANGUAGES[state.lang].messages.loading, false);
        elements.applyFiltersBtn.disabled = true;

        const { json, headers } = await readFile(file);
        state.rawHeaders = headers;
        state.data = validateAndCleanData(json, headers);

        // Update UI status
        elements.fileNameDisplay.textContent = file.name;
        elements.fileNameDisplay.classList.remove('hidden');

        const successMsg = LANGUAGES[state.lang].messages.fileUploadSuccess
            .replace('{fileName}', file.name)
            .replace('{count}', state.data.length);

        showMessage(elements.statusMessage, successMsg, false);
        elements.content.classList.remove('hidden');
        elements.applyFiltersBtn.disabled = false;
        elements.compareBtn.disabled = false; // Enable comparison button

        // Initial filter application
        applyFilters();

      } catch (error) {
        if (error.message.includes('missing columns') || error.message.includes('empty data')) {
            // Error message already shown by validateAndCleanData
        } else {
            const msg = LANGUAGES[state.lang].messages.error.replace('{error}', error.message);
            showMessage(elements.errorMessage, msg, true);
        }
        state.data = [];
        state.filteredData = [];
        elements.fileNameDisplay.classList.add('hidden');
        elements.content.classList.add('hidden');
        elements.applyFiltersBtn.disabled = true;
        elements.compareBtn.disabled = true;
        elements.exportSummaryBtn.disabled = true;
        elements.exportDriversBtn.disabled = true;
        elements.exportAnomBtn.disabled = true;
      }
    };


    // --- Filtering and Aggregation ---

    const applyFilters = (data = state.data) => {
      if (data.length === 0) return;

      const startDate = elements.startDate.value ? new Date(elements.startDate.value).getTime() : 0;
      const endDate = elements.endDate.value ? new Date(elements.endDate.value).setHours(23, 59, 59, 999) : Infinity; // Include whole day
      const shiftFilter = elements.shiftFilter.value;
      const operationFilter = elements.operationFilter.value;

      state.targetUtilization = parseFloat(elements.targetUtilFilter.value) || 65;

      state.filteredData = data.filter(row => {
        const rowTime = row.startTime.getTime();
        const isInDateRange = rowTime >= startDate && rowTime <= endDate;
        const isInShift = shiftFilter === 'all' || row.shift === shiftFilter;
        const isInOperation = operationFilter === 'all' || row.operation === operationFilter;

        return isInDateRange && isInShift && isInOperation;
      });

      if (state.filteredData.length === 0) {
        showMessage(elements.warningMessage, LANGUAGES[state.lang].messages.emptyData, false, true);
        elements.exportSummaryBtn.disabled = true;
        elements.exportDriversBtn.disabled = true;
        elements.exportAnomBtn.disabled = true;
        // Clear tables and charts
        renderSummaryTable(true);
        renderDriverDetailsTable(true);
        renderAnomalyTable(true);
        destroyCharts();
        return;
      } else {
        showMessage(elements.statusMessage, `${LANGUAGES[state.lang].messages.loading}`, false);
      }

      // Run aggregations and rendering
      runAnalysis();
    };

    const runAnalysis = (data = state.filteredData) => {
        // 1. Grouping/Summary
        const groupingKey = elements.groupingSelect.value === 'machineId' ? 'machineId' : elements.groupingSelect.value;
        state.summary = aggregateData(data, groupingKey);

        // 2. Driver Details (always grouped by driver)
        state.drivers = aggregateData(data, 'driver');

        // 3. Anomalies (always based on individual records)
        state.anomalies = checkAnomalies(data);

        // 4. Weekly Data (for driver chart)
        state.weekly = aggregateWeeklyData(data);

        // Update UI
        renderSummaryTable();
        renderCharts();
        renderDriverDetailsTable();
        renderWeeklyChart();
        renderAnomalyTable();

        elements.exportSummaryBtn.disabled = state.summary.length === 0;
        elements.exportDriversBtn.disabled = state.drivers.length === 0;
        elements.exportAnomBtn.disabled = state.anomalies.length === 0;

        showMessage(elements.statusMessage, `Analýza dokončena. Zobrazeno **${state.filteredData.length}** záznamů.`, false);
    };

    const aggregateData = (data, groupBy) => {
      const groups = data.reduce((acc, row) => {
        const key = row[groupBy] || 'N/A';
        if (!acc[key]) {
          acc[key] = {
            key: key,
            keyTime: 0,
            operatingTime: 0,
            drivingTime: 0,
            liftingTime: 0,
            loadedTime: 0,
            idleTime: 0,
            count: 0,
            machines: new Set(),
            operations: new Set(),
          };
        }

        acc[key].keyTime += row['Čas klíče (s)'];
        acc[key].operatingTime += row['Provozní doba (s)'];
        acc[key].drivingTime += row['Čas jízdy (s)'];
        acc[key].liftingTime += row['Čas zdvihu (s)'];
        acc[key].loadedTime += row['Čas se zátěží (s)'];
        acc[key].idleTime += row.idleTime;
        acc[key].count++;

        if (groupBy !== 'machine' && groupBy !== 'machineId') {
            acc[key].machines.add(row.machineId);
        }
        if (row.operation !== 'All') {
            acc[key].operations.add(row.operation);
        }


        return acc;
      }, {});

      return Object.values(groups).map(group => {
        const keyTime = group.keyTime;
        const operatingTime = group.operatingTime;
        const loadedTime = group.loadedTime;

        group.utilization = keyTime > 0 ? (operatingTime / keyTime) * 100 : 0;
        group.loadedUtilization = operatingTime > 0 ? (loadedTime / operatingTime) * 100 : 0;
        group.operationText = Array.from(group.operations).sort().join(', ') || LANGUAGES[state.lang].metricNames.operation;
        group.numMachines = group.machines.size;
        return group;
      }).sort((a, b) => b.keyTime - a.keyTime); // Sort by total key time descending
    };

    const aggregateWeeklyData = (data) => {
        // Group by Driver and then by Day of Week
        const driverDayOfWeek = data.reduce((acc, row) => {
            const driver = row.driver || 'N/A';
            const weekDay = row.weekDay; // 1 (Mon) to 7 (Sun)
            const key = `${driver}-${weekDay}`;

            if (!acc[key]) {
                acc[key] = {
                    driver,
                    weekDay,
                    keyTime: 0,
                    operatingTime: 0,
                    dayCount: 0, // Number of records for this driver on this day
                };
            }

            acc[key].keyTime += row['Čas klíče (s)'];
            acc[key].operatingTime += row['Provozní doba (s)'];
            acc[key].dayCount++;
            return acc;
        }, {});

        // Calculate utilization and group by driver
        const driversWeekly = Object.values(driverDayOfWeek).map(group => {
            group.utilization = group.keyTime > 0 ? (group.operatingTime / group.keyTime) * 100 : 0;
            return group;
        }).reduce((acc, row) => {
            if (!acc[row.driver]) {
                acc[row.driver] = {
                    key: row.driver,
                    weeklyData: Array(7).fill(null), // Array for 7 days (index 0 for Mon, 6 for Sun)
                    totalKeyTime: 0,
                };
            }
            acc[row.driver].weeklyData[row.weekDay - 1] = row; // Map 1-7 to 0-6
            acc[row.driver].totalKeyTime += row.keyTime;
            return acc;
        }, {});

        // Sort drivers by total key time
        return Object.values(driversWeekly).sort((a, b) => b.totalKeyTime - a.totalKeyTime);
    };


    const checkAnomalies = (data) => {
        const anomalies = [];
        const targetUtil = state.targetUtilization;

        data.forEach(row => {
            const rowAnomalies = [];

            // 1. Low utilization
            if (row.utilization < targetUtil && row.keyTime > 300) { // Key time > 5 min
                rowAnomalies.push(LANGUAGES[state.lang].anomalyCategories.lowUtil.replace('{val}', targetUtil));
            }

            // 2. Short operating time / Key Time ratio anomaly (e.g., long key time with very short operating time)
            if (row.keyTime > 3600 && row.operatingTime < 300) { // Key time > 1h, Operating time < 5min
                rowAnomalies.push(LANGUAGES[state.lang].anomalyCategories.shortOpTime);
            }

            // 3. Zero key time (should be filtered out, but check as safety)
            if (row.keyTime === 0) {
                rowAnomalies.push(LANGUAGES[state.lang].anomalyCategories.zeroKeyTime);
            }

            if (rowAnomalies.length > 0) {
                anomalies.push({
                    ...row,
                    anomalyText: rowAnomalies.join('; ')
                });
            }
        });

        return anomalies.sort((a, b) => b.utilization - a.utilization);
    };


    // --- Rendering Tables ---

    const renderSummaryTable = (isEmpty = false) => {
      let html = '';
      const summaryData = isEmpty ? [] : state.summary;
      const lang = state.lang;
      const targetUtil = state.targetUtilization;

      if (summaryData.length === 0) {
        const msg = isEmpty ? LANGUAGES[lang].messages.emptyData : LANGUAGES[lang].messages.noAnomaly;
        html = `<tr><td colspan="11" class="text-center p-4 text-slate-500">${msg}</td></tr>`;
      } else {
        summaryData.forEach((row, index) => {
            const isLowUtil = row.utilization < targetUtil;
            const utilClass = isLowUtil ? 'bg-red-100 text-red-700 font-bold' : 'bg-green-100 text-green-700 font-bold';
            const groupingKey = row.key;
            const operationText = row.operationText;

            html += `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 text-center">${index + 1}</td>
                    <td class="p-3 font-medium">${groupingKey}</td>
                    <td class="p-3 text-right">${formatTime(row.keyTime, 'h', lang)}</td>
                    <td class="p-3 text-right">${formatTime(row.operatingTime, 'h', lang)}</td>
                    <td class="p-3 text-right ${utilClass}">${formatDecimal(row.utilization, 1, lang)}%</td>
                    <td class="p-3 text-right text-sky-700">${formatTime(row.drivingTime, 'min', lang)}</td>
                    <td class="p-3 text-right text-indigo-700">${formatTime(row.liftingTime, 'min', lang)}</td>
                    <td class="p-3 text-right text-yellow-700">${formatTime(row.idleTime, 'h', lang)}</td>
                    <td class="p-3 text-right">${formatTime(row.loadedTime, 'min', lang)}</td>
                    <td class="p-3 text-right">${formatDecimal(row.loadedUtilization, 1, lang)}%</td>
                    <td class="p-3 text-right">${operationText}</td>
                </tr>
            `;
        });
      }

      elements.summaryTableBody.innerHTML = html;
      renderSummaryTotal(summaryData);
    };

    const renderSummaryTotal = (summaryData) => {
        if (summaryData.length === 0) {
            elements.summaryTableTotal.innerHTML = '';
            return;
        }

        const total = summaryData.reduce((acc, row) => {
            acc.keyTime += row.keyTime;
            acc.operatingTime += row.operatingTime;
            acc.drivingTime += row.drivingTime;
            acc.liftingTime += row.liftingTime;
            acc.idleTime += row.idleTime;
            acc.loadedTime += row.loadedTime;
            return acc;
        }, { keyTime: 0, operatingTime: 0, drivingTime: 0, liftingTime: 0, idleTime: 0, loadedTime: 0 });

        const totalUtil = total.keyTime > 0 ? (total.operatingTime / total.keyTime) * 100 : 0;
        const totalLoadedUtil = total.operatingTime > 0 ? (total.loadedTime / total.operatingTime) * 100 : 0;

        const lang = state.lang;

        elements.summaryTableTotal.innerHTML = `
            <td class="p-3 text-center" colspan="2"><span class="lang-cs">CELKEM</span><span class="lang-en hidden">TOTAL</span></td>
            <td class="p-3 text-right">${formatTime(total.keyTime, 'h', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.operatingTime, 'h', lang)}</td>
            <td class="p-3 text-right">${formatDecimal(totalUtil, 1, lang)}%</td>
            <td class="p-3 text-right">${formatTime(total.drivingTime, 'min', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.liftingTime, 'min', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.idleTime, 'h', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.loadedTime, 'min', lang)}</td>
            <td class="p-3 text-right">${formatDecimal(totalLoadedUtil, 1, lang)}%</td>
            <td class="p-3 text-right"></td>
        `;
    };

    const renderDriverDetailsTable = (isEmpty = false) => {
        let html = '';
        const driverData = isEmpty ? [] : state.drivers;
        const lang = state.lang;
        const targetUtil = state.targetUtilization;

        if (driverData.length === 0) {
            html = `<tr><td colspan="9" class="text-center p-4 text-slate-500">${LANGUAGES[lang].messages.emptyData}</td></tr>`;
        } else {
            driverData.forEach((row, index) => {
                const isLowUtil = row.utilization < targetUtil;
                const utilClass = isLowUtil ? 'bg-red-100 text-red-700 font-bold' : 'bg-green-100 text-green-700 font-bold';

                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3 font-medium">${row.key}</td>
                        <td class="p-3 text-right">${formatTime(row.keyTime, 'h', lang)}</td>
                        <td class="p-3 text-right">${formatTime(row.operatingTime, 'h', lang)}</td>
                        <td class="p-3 text-right ${utilClass}">${formatDecimal(row.utilization, 1, lang)}%</td>
                        <td class="p-3 text-right text-sky-700">${formatTime(row.drivingTime, 'min', lang)}</td>
                        <td class="p-3 text-right text-indigo-700">${formatTime(row.liftingTime, 'min', lang)}</td>
                        <td class="p-3 text-right">${formatTime(row.loadedTime, 'min', lang)}</td>
                        <td class="p-3 text-right">${row.numMachines}</td>
                    </tr>
                `;
            });
        }

        elements.driverDetailsTableBody.innerHTML = html;
        renderDriverDetailsTotal(driverData);
    };

    const renderDriverDetailsTotal = (driverData) => {
        if (driverData.length === 0) {
            elements.driverDetailsTableTotal.innerHTML = '';
            return;
        }

        const total = driverData.reduce((acc, row) => {
            acc.keyTime += row.keyTime;
            acc.operatingTime += row.operatingTime;
            acc.drivingTime += row.drivingTime;
            acc.liftingTime += row.liftingTime;
            acc.loadedTime += row.loadedTime;
            return acc;
        }, { keyTime: 0, operatingTime: 0, drivingTime: 0, liftingTime: 0, loadedTime: 0 });

        const totalUtil = total.keyTime > 0 ? (total.operatingTime / total.keyTime) * 100 : 0;

        const lang = state.lang;

        elements.driverDetailsTableTotal.innerHTML = `
            <td class="p-3 text-center" colspan="2"><span class="lang-cs">CELKEM</span><span class="lang-en hidden">TOTAL</span></td>
            <td class="p-3 text-right">${formatTime(total.keyTime, 'h', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.operatingTime, 'h', lang)}</td>
            <td class="p-3 text-right">${formatDecimal(totalUtil, 1, lang)}%</td>
            <td class="p-3 text-right">${formatTime(total.drivingTime, 'min', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.liftingTime, 'min', lang)}</td>
            <td class="p-3 text-right">${formatTime(total.loadedTime, 'min', lang)}</td>
            <td class="p-3 text-right"></td>
        `;
    };

    const renderAnomalyTable = (isEmpty = false) => {
        let html = '';
        const anomalyData = isEmpty ? [] : state.anomalies;
        const lang = state.lang;
        const targetUtil = state.targetUtilization;

        if (anomalyData.length === 0) {
            const msg = isEmpty ? LANGUAGES[lang].messages.emptyData : LANGUAGES[lang].messages.noAnomaly;
            html = `<tr><td colspan="7" class="text-center p-4 text-slate-500">${msg}</td></tr>`;
        } else {
            anomalyData.forEach((row, index) => {
                const utilClass = row.utilization < targetUtil ? 'text-red-700 font-bold' : 'text-slate-700';

                html += `
                    <tr class="hover:bg-red-50">
                        <td class="p-3">${formatDate(row.dateOnly, lang)}</td>
                        <td class="p-3">${row.machineId}</td>
                        <td class="p-3">${row.driver}</td>
                        <td class="p-3 text-right">${formatTime(row.keyTime, 'h', lang)}</td>
                        <td class="p-3 text-right">${formatTime(row.operatingTime, 'min', lang)}</td>
                        <td class="p-3 text-right ${utilClass}">${formatDecimal(row.utilization, 1, lang)}%</td>
                        <td class="p-3 text-red-600 font-medium">${row.anomalyText}</td>
                    </tr>
                `;
            });
        }
        elements.anomalyTableBody.innerHTML = html;
    };


    // --- Rendering Charts ---

    const destroyCharts = () => {
        Object.values(state.charts).forEach(chart => {
            if (chart) chart.destroy();
        });
        state.charts = {};
    };

    const renderCharts = () => {
        destroyCharts();
        if (state.summary.length === 0) return;

        // --- Data preparation for Charts ---

        // 1. Utilization Chart & Stacked Chart (Summary Data)
        const summaryData = state.summary.slice(0, 10); // Top 10 for charts
        const labels = summaryData.map(d => d.key);

        const utilData = summaryData.map(d => d.utilization);
        const operatingTimeData = summaryData.map(d => d.operatingTime / 3600);
        const idleTimeData = summaryData.map(d => d.idleTime / 3600);
        const loadedTimeData = summaryData.map(d => d.loadedTime / 3600);

        // 2. Heatmap Data (Hourly Utilization)
        const hourlyData = Array(24).fill(0).map(() => ({ totalUtil: 0, count: 0 })); // Index 0 for 00:00-01:00

        state.filteredData.forEach(row => {
            if (row.hourOnly !== null && row.hourOnly >= 0 && row.hourOnly < 24) {
                hourlyData[row.hourOnly].totalUtil += row.utilization;
                hourlyData[row.hourOnly].count++;
            }
        });

        const hourlyUtilization = hourlyData.map(d => d.count > 0 ? d.totalUtil / d.count : 0);
        const heatmapData = hourlyUtilization.map((util, index) => ({
            x: index, // Hour 0-23
            y: 0, // Single row
            v: util,
            hourLabel: `${index.toString().padStart(2, '0')}:00 - ${(index + 1).toString().padStart(2, '0')}:00`
        }));


        // 3. Daily Trend Data
        const dailyGroups = aggregateData(state.filteredData, 'dateOnly');
        const dailyTrendLabels = dailyGroups.map(d => formatDate(d.key, state.lang)).reverse();
        const dailyTrendData = dailyGroups.map(d => d.utilization).reverse();


        // --- Chart Rendering ---

        // Chart 1: Utilization Bar Chart
        state.charts.utilChart = new Chart(document.getElementById('utilChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: LANGUAGES[state.lang].metricNames.utilization,
                    data: utilData,
                    backgroundColor: utilData.map(util => util < state.targetUtilization ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)'), // Red or Green
                    borderColor: utilData.map(util => util < state.targetUtilization ? 'rgba(239, 68, 68, 1)' : 'rgba(34, 197, 94, 1)'),
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: LANGUAGES[state.lang].metricNames.loadedUtilization,
                    data: summaryData.map(d => d.loadedUtilization),
                    type: 'line',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false }
                },
                scales: {
                    x: {
                        title: { display: true, text: LANGUAGES[state.lang].groupingOptions[elements.groupingSelect.value] }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: LANGUAGES[state.lang].metricNames.utilization + ' (%)' }
                    }
                }
            }
        });

        // Chart 2: Stacked Bar Chart (Time Breakdown)
        state.charts.stackChart = new Chart(document.getElementById('stackChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: LANGUAGES[state.lang].metricNames.drivingTime + ` (${LANGUAGES[state.lang].timeUnits.h})`,
                        data: summaryData.map(d => d.drivingTime / 3600),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                    },
                    {
                        label: LANGUAGES[state.lang].metricNames.liftingTime + ` (${LANGUAGES[state.lang].timeUnits.h})`,
                        data: summaryData.map(d => d.liftingTime / 3600),
                        backgroundColor: 'rgba(124, 58, 237, 0.8)', // Violet
                    },
                    {
                        label: LANGUAGES[state.lang].metricNames.idleTime + ` (${LANGUAGES[state.lang].timeUnits.h})`,
                        data: idleTimeData,
                        backgroundColor: 'rgba(251, 191, 36, 0.8)', // Yellow
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        stacked: true,
                        title: { display: true, text: LANGUAGES[state.lang].groupingOptions[elements.groupingSelect.value] }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: LANGUAGES[state.lang].metricNames.keyTime + ` (${LANGUAGES[state.lang].timeUnits.h})` }
                    }
                }
            }
        });

        // Chart 3: Hourly Heatmap
        state.charts.heatmapChart = new Chart(document.getElementById('heatmapChart'), {
            type: 'matrix',
            data: {
                datasets: [{
                    label: LANGUAGES[state.lang].metricNames.utilization + ' (%)',
                    data: heatmapData,
                    backgroundColor(context) {
                        const value = context.dataset.data[context.dataIndex].v;
                        const alpha = Math.min(1, value / 100);
                        const hue = value < state.targetUtilization ? 0 : 120; // Red or Green hue
                        return `hsl(${hue}, 80%, ${50 + (1 - alpha) * 30}%)`;
                    },
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    height: (ctx) => (ctx.chart.chartArea || {}).height / 1,
                    width: (ctx) => (ctx.chart.chartArea || {}).width / 24,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (context) => context[0].dataset.data[context[0].dataIndex].hourLabel,
                            label: (context) => `${LANGUAGES[state.lang].metricNames.utilization}: ${formatDecimal(context.dataset.data[context.dataIndex].v, 1, state.lang)}%`,
                        }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        type: 'category',
                        labels: Array(24).fill(0).map((_, i) => `${i.toString().padStart(2, '0')}`),
                        ticks: { autoSkip: false, maxRotation: 0, minRotation: 0 },
                        grid: { display: false },
                        position: 'bottom'
                    },
                    y: {
                        type: 'category',
                        labels: [''], // Single row
                        grid: { display: false }
                    }
                }
            }
        });

        // Chart 4: Daily Trend Line Chart
        state.charts.trendChart = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: dailyTrendLabels,
                datasets: [{
                    label: LANGUAGES[state.lang].metricNames.utilization,
                    data: dailyTrendData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.2,
                    borderWidth: 2,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    x: { title: { display: true, text: LANGUAGES[state.lang].metricNames.day } },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: LANGUAGES[state.lang].metricNames.utilization + ' (%)' }
                    }
                }
            }
        });
    };

    const renderWeeklyChart = () => {
        if(state.charts.weeklyChart) state.charts.weeklyChart.destroy();
        if (state.weekly.length === 0) {
            console.log(LANGUAGES[state.lang].messages.noWeeklyData);
            return;
        }

        // Limit to top 10 drivers
        const weeklyData = state.weekly.slice(0, 10);
        const labels = weeklyData.map(d => d.key); // Driver IDs
        const datasets = [];
        const dayLabels = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
        const dayLabelsEn = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // Prepare datasets (one line per driver)
        const driverColors = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981',
            '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f472b6'
        ];

        weeklyData.forEach((driverData, index) => {
            datasets.push({
                label: driverData.key,
                data: driverData.weeklyData.map(d => d ? d.utilization : null),
                borderColor: driverColors[index % driverColors.length],
                backgroundColor: driverColors[index % driverColors.length] + '40', // Light fill
                fill: false,
                tension: 0.1,
                borderWidth: 2,
                pointRadius: 4,
                spanGaps: true // Connect points over missing data
            });
        });

        state.charts.weeklyChart = new Chart(document.getElementById('weeklyChart'), {
            type: 'line',
            data: {
                labels: state.lang === 'cs' ? dayLabels : dayLabelsEn,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatDecimal(context.parsed.y, 1, state.lang)}%`
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: LANGUAGES[state.lang].metricNames.weekDay } },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: LANGUAGES[state.lang].metricNames.utilization + ' (%)' }
                    }
                }
            }
        });
    };


    // --- Comparison Logic ---

    const getComparisonPeriod = () => {
        const start = elements.startDate.value;
        const end = elements.endDate.value;

        if (!start || !end) return null;

        const currentStart = new Date(start).getTime();
        const currentEnd = new Date(end).setHours(23, 59, 59, 999);
        const currentDurationMs = currentEnd - currentStart;

        let compStart, compEnd;
        const mode = elements.comparisonMode.value;

        if (mode === 'previous') {
            // Previous period (same length)
            compEnd = currentStart - 86400000; // Day before current start
            compStart = compEnd - currentDurationMs;
        } else if (mode === 'custom') {
            // Custom date range
            const customStart = elements.compStartDate.value;
            const customEnd = elements.compEndDate.value;
            if (!customStart || !customEnd) return null;

            compStart = new Date(customStart).getTime();
            compEnd = new Date(customEnd).setHours(23, 59, 59, 999);
        }

        if (!compStart || !compEnd || compStart >= compEnd) return null;

        return {
            start: new Date(compStart).toISOString().split('T')[0],
            end: new Date(compEnd).toISOString().split('T')[0]
        };
    };

    const runComparison = () => {
        if (state.data.length === 0) return;

        const compPeriod = getComparisonPeriod();
        if (!compPeriod) {
            showMessage(elements.warningMessage, "Nastavte prosím platné datumové rozsahy pro porovnání.", false, true);
            return;
        }

        const groupingKey = elements.groupingSelect.value === 'machineId' ? 'machineId' : elements.groupingSelect.value;
        const currentSummary = state.summary;

        // Filter data for comparison period
        const comparisonData = state.data.filter(row => {
            const rowTime = row.startTime.getTime();
            const compStartDate = new Date(compPeriod.start).getTime();
            const compEndDate = new Date(compPeriod.end).setHours(23, 59, 59, 999);
            const shiftFilter = elements.shiftFilter.value;
            const operationFilter = elements.operationFilter.value;

            const isInDateRange = rowTime >= compStartDate && rowTime <= compEndDate;
            const isInShift = shiftFilter === 'all' || row.shift === shiftFilter;
            const isInOperation = operationFilter === 'all' || row.operation === operationFilter;

            return isInDateRange && isInShift && isInOperation;
        });

        if (comparisonData.length === 0) {
            showMessage(elements.warningMessage, LANGUAGES[state.lang].messages.noComparisonData, false, true);
            elements.comparisonResults.classList.add('hidden');
            return;
        }

        const comparisonSummary = aggregateData(comparisonData, groupingKey);

        // Merge and prepare final comparison data
        const currentMap = currentSummary.reduce((acc, item) => {
            acc[item.key] = item;
            return acc;
        }, {});

        const compMap = comparisonSummary.reduce((acc, item) => {
            acc[item.key] = item;
            return acc;
        }, {});

        const allKeys = [...new Set([...Object.keys(currentMap), ...Object.keys(compMap)])].sort();

        const comparisonResults = allKeys.map(key => {
            const current = currentMap[key] || { keyTime: 0, operatingTime: 0, utilization: 0 };
            const comp = compMap[key] || { keyTime: 0, operatingTime: 0, utilization: 0 };

            const utilDiff = current.utilization - comp.utilization;
            const opTimeDiff = current.operatingTime - comp.operatingTime;

            return {
                key,
                currentUtil: current.utilization,
                compUtil: comp.utilization,
                utilDiff,
                currentOpTime: current.operatingTime,
                compOpTime: comp.operatingTime,
                opTimeDiff
            };
        }).sort((a, b) => b.utilDiff - a.utilDiff);


        // Update UI
        elements.currentPeriodRange.textContent = `${formatDate(elements.startDate.value, state.lang)} - ${formatDate(elements.endDate.value, state.lang)}`;
        elements.currentPeriodRangeEn.textContent = `${formatDate(elements.startDate.value, 'en')} - ${formatDate(elements.endDate.value, 'en')}`;

        elements.compPeriodRange.textContent = `${formatDate(compPeriod.start, state.lang)} - ${formatDate(compPeriod.end, state.lang)}`;
        elements.compPeriodRangeEn.textContent = `${formatDate(compPeriod.start, 'en')} - ${formatDate(compPeriod.end, 'en')}`;

        renderComparisonTable(comparisonResults);
        renderComparisonChart(comparisonResults);

        elements.comparisonResults.classList.remove('hidden');
        showMessage(elements.statusMessage, `Porovnání dokončeno. Zobrazeno ${comparisonResults.length} záznamů.`, false);
    };

    const renderComparisonTable = (data) => {
        let html = '';
        const lang = state.lang;

        if (data.length === 0) {
            html = `<tr><td colspan="7" class="text-center p-4 text-slate-500">${LANGUAGES[lang].messages.noComparisonData}</td></tr>`;
        } else {
            data.forEach((row) => {
                const diffClass = row.utilDiff > 0 ? 'text-green-600 font-bold' : (row.utilDiff < 0 ? 'text-red-600 font-bold' : 'text-slate-600');

                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 font-medium">${row.key}</td>
                        <td class="p-3 text-right">${formatDecimal(row.currentUtil, 1, lang)}%</td>
                        <td class="p-3 text-right">${formatDecimal(row.compUtil, 1, lang)}%</td>
                        <td class="p-3 text-right ${diffClass}">${row.utilDiff > 0 ? '+' : ''}${formatDecimal(row.utilDiff, 1, lang)}%</td>
                        <td class="p-3 text-right">${formatSecondsToHours(row.currentOpTime, lang)} ${LANGUAGES[lang].timeUnits.h}</td>
                        <td class="p-3 text-right">${formatSecondsToHours(row.compOpTime, lang)} ${LANGUAGES[lang].timeUnits.h}</td>
                        <td class="p-3 text-right ${diffClass}">${row.opTimeDiff > 0 ? '+' : ''}${formatSecondsToHours(row.opTimeDiff, lang)} ${LANGUAGES[lang].timeUnits.h}</td>
                    </tr>
                `;
            });
        }
        elements.comparisonTableBody.innerHTML = html;
    };

    const renderComparisonChart = (data) => {
        if(state.charts.comparisonChart) state.charts.comparisonChart.destroy();

        // Top 10 by OpTime for clarity
        const sortedData = data.sort((a, b) => b.currentOpTime - a.currentOpTime).slice(0, 10);
        const labels = sortedData.map(d => d.key);

        state.charts.comparisonChart = new Chart(document.getElementById('comparisonChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: LANGUAGES[state.lang].metricNames.utilization + ' (%) - Aktuální',
                        data: sortedData.map(d => d.currentUtil),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                    },
                    {
                        label: LANGUAGES[state.lang].metricNames.utilization + ' (%) - Porov.',
                        data: sortedData.map(d => d.compUtil),
                        backgroundColor: 'rgba(234, 179, 8, 0.8)', // Yellow
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatDecimal(context.parsed.y, 1, state.lang)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: LANGUAGES[state.lang].groupingOptions[elements.groupingSelect.value] }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: LANGUAGES[state.lang].metricNames.utilization + ' (%)' }
                    }
                }
            }
        });
    };


    // --- Export Logic (CSV) ---

    const toCsvSummary = (data, groupingKey, lang) => {
        if (data.length === 0) return null;
        const metrics = LANGUAGES[lang].metricNames;

        const header = [
            '#',
            metrics[groupingKey === 'machineId' ? 'machineId' : groupingKey],
            metrics.keyTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            metrics.operatingTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            metrics.utilization + ' (%)',
            metrics.drivingTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            metrics.liftingTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            metrics.idleTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            metrics.loadedTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            metrics.loadedUtilization + ' (%)',
            metrics.operation
        ].join(';');

        const rows = data.map((row, index) => {
            return [
                index + 1,
                row.key,
                formatSecondsToHours(row.keyTime, lang),
                formatSecondsToHours(row.operatingTime, lang),
                formatDecimal(row.utilization, 1, lang),
                (row.drivingTime / 60).toFixed(1).toLocaleString(lang),
                (row.liftingTime / 60).toFixed(1).toLocaleString(lang),
                formatSecondsToHours(row.idleTime, lang),
                (row.loadedTime / 60).toFixed(1).toLocaleString(lang),
                formatDecimal(row.loadedUtilization, 1, lang),
                row.operationText
            ].join(';');
        });

        return [header, ...rows].join('\n');
    };

    const toCsvDrivers = (data, lang) => {
        if (data.length === 0) return null;
        const metrics = LANGUAGES[lang].metricNames;

        const header = [
            '#',
            metrics.driver,
            metrics.keyTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            metrics.operatingTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            metrics.utilization + ' (%)',
            metrics.drivingTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            metrics.liftingTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            metrics.loadedTime + ` (${LANGUAGES[lang].timeUnits.min})`,
            'Počet strojů'
        ].join(';');

        const rows = data.map((row, index) => {
            return [
                index + 1,
                row.key,
                formatSecondsToHours(row.keyTime, lang),
                formatSecondsToHours(row.operatingTime, lang),
                formatDecimal(row.utilization, 1, lang),
                (row.drivingTime / 60).toFixed(1).toLocaleString(lang),
                (row.liftingTime / 60).toFixed(1).toLocaleString(lang),
                (row.loadedTime / 60).toFixed(1).toLocaleString(lang),
                row.numMachines
            ].join(';');
        });

        return [header, ...rows].join('\n');
    };

    const toCsvAnomalies = (data, lang) => {
        if (data.length === 0) return null;

        const header = [
            LANGUAGES[lang].metricNames.day,
            'Stroj / Flotila',
            LANGUAGES[lang].metricNames.driver,
            LANGUAGES[lang].metricNames.keyTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            LANGUAGES[lang].metricNames.operatingTime + ` (${LANGUAGES[lang].timeUnits.h})`,
            LANGUAGES[lang].metricNames.utilization + ' (%)',
            'Kategorie anomálie'
        ].join(';');

        const rows = data.map((row) => {
            return [
                formatDate(row.dateOnly, lang),
                row.machineId,
                row.driver,
                formatSecondsToHours(row.keyTime, lang),
                formatSecondsToHours(row.operatingTime, lang),
                formatDecimal(row.utilization, 1, lang),
                `"${row.anomalyText.replace(/"/g, '""')}"` // Handle quotes in anomaly text
            ].join(';');
        });

        return [header, ...rows].join('\n');
    };

    const toCsvWeeks = (data, lang) => {
        if (data.length === 0) return null;

        const dayLabels = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
        const dayLabelsEn = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const currentDayLabels = lang === 'cs' ? dayLabels : dayLabelsEn;

        const header = [
            LANGUAGES[lang].metricNames.driver,
            ...currentDayLabels.map(d => `${d} Util. (%)`),
            ...currentDayLabels.map(d => `${d} Key Time (${LANGUAGES[lang].timeUnits.h})`),
        ].join(';');

        const rows = data.map((driverData) => {
            const row = [driverData.key];
            const utilData = [];
            const keyTimeData = [];

            driverData.weeklyData.forEach(day => {
                utilData.push(day ? formatDecimal(day.utilization, 1, lang) : '');
                keyTimeData.push(day ? formatSecondsToHours(day.keyTime, lang) : '');
            });

            return [...row, ...utilData, ...keyTimeData].join(';');
        });

        return [header, ...rows].join('\n');
    };


    // --- Event Listeners ---

    // File Input / Drag & Drop
    elements.fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    elements.dropzone.addEventListener('click', () => {
      elements.fileInput.click();
    });

    elements.dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      elements.dropzone.classList.add('dragover');
    });

    elements.dropzone.addEventListener('dragleave', () => {
      elements.dropzone.classList.remove('dragover');
    });

    elements.dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      elements.dropzone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    // Filters
    elements.applyFiltersBtn.addEventListener('click', () => {
      applyFilters();
    });

    // Language switch
    elements.languageSelect.addEventListener('change', (e) => {
        state.lang = e.target.value;
        updateUI();
        // Re-run filter/analysis to ensure all content (incl. totals, charts) is updated
        if (state.data.length > 0) applyFilters();
    });

    // Tabs
    document.querySelectorAll('[data-tabs-target]').forEach(button => {
        button.addEventListener('click', (e) => {
            const targetId = e.currentTarget.getAttribute('data-tabs-target');
            const target = document.querySelector(targetId);
            const container = document.getElementById('myTabContent');

            // Deactivate all
            document.querySelectorAll('[data-tabs-target]').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('border-indigo-600', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-600', 'hover:border-gray-300');
            });
            container.querySelectorAll('div[role="tabpanel"]').forEach(panel => {
                panel.classList.add('hidden');
                panel.classList.remove('active');
            });

            // Activate current
            e.currentTarget.classList.add('active');
            e.currentTarget.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-600', 'hover:border-gray-300');
            e.currentTarget.classList.add('border-indigo-600', 'text-indigo-600');
            target.classList.remove('hidden');
            target.classList.add('active');

            // If it's the comparison tab, update the grouping title
            if (targetId === '#comparison') {
                const groupingKey = elements.groupingSelect.value;
                const groupingName = LANGUAGES[state.lang].groupingOptions[groupingKey === 'machineId' ? 'machineId' : groupingKey];
                elements.compGroupingTitle.textContent = groupingName;
                elements.compGroupingTitleEn.textContent = groupingName;
                elements.compTableGroupingHeader.innerHTML = `<span class="lang-cs">${groupingName}</span><span class="lang-en hidden">${groupingName}</span>`;
            }
        });
    });

    // Comparison Mode change
    elements.comparisonMode.addEventListener('change', (e) => {
        if (e.target.value === 'custom') {
            elements.customDateRangeInputs.classList.remove('hidden');
        } else {
            elements.customDateRangeInputs.classList.add('hidden');
        }
    });

    // Run Comparison
    elements.compareBtn.addEventListener('click', runComparison);

    // Export Buttons
    elements.exportSummaryBtn.addEventListener('click', () => {
        const groupingKey = elements.groupingSelect.value;
        const csv = toCsvSummary(state.summary, groupingKey, state.lang);
        if(!csv){ alert(state.lang==='cs' ? 'Žádná souhrnná data' : 'No summary data'); return; }
        const blob = new Blob(["\ufeff" + csv, {type: "text/csv;charset=utf-8;"}]); // Add BOM for Czech characters
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `machine_activity_summary_${groupingKey}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    });

    elements.exportDriversBtn.addEventListener('click', () => {
        const csv = toCsvDrivers(state.drivers, state.lang);
        if(!csv){ alert(state.lang==='cs' ? 'Žádná data řidičů' : 'No driver data'); return; }
        const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_drivers.csv";
        link.click();
        URL.revokeObjectURL(link.href);
    });

    const exportAnomBtn = document.getElementById("exportAnomBtn");
    if(exportAnomBtn){
      exportAnomBtn.addEventListener("click", ()=>{
        const csv = toCsvAnomalies(state.anomalies, state.lang);
        if(!csv){ alert(state.lang==='cs' ? 'Žádné anomálie' : 'No anomalies'); return; }
        const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_anomalies.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      });
    }

    // Print / PDF export button handler: triggers browser print dialog
    const printBtn = document.getElementById('printBtn');
    if(printBtn){
      printBtn.addEventListener('click', () => {
        const start = elements.startDate.value ? formatDate(elements.startDate.value, state.lang) : 'Neznámé datum';
        const end = elements.endDate.value ? formatDate(elements.endDate.value, state.lang) : 'Neznámé datum';
        elements.printDateRange.textContent = `${start} - ${end}`;
        window.print();
      });
    }

    const exportWeeksBtn = document.getElementById("exportWeeksBtn");
    if(exportWeeksBtn){
      exportWeeksBtn.addEventListener("click", () => {
        const csv = toCsvWeeks(state.weekly, state.lang);
        if(!csv){ alert(state.lang==='cs' ? 'Žádná týdenní data' : 'No weekly data'); return; }
        const blob = new Blob(["\ufeff" + csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_weekly_utilization.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      });
    }

    // Initial setup
    updateUI(); // Set correct language strings initially

    // Set initial active tab styling
    document.getElementById('summary-tab').classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-600', 'hover:border-gray-300');
    document.getElementById('summary-tab').classList.add('border-indigo-600', 'text-indigo-600');

  </script>
</body>
</html>
