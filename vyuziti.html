<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analýza aktivit strojů • Machine Activity Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Matrix/heatmap plugin for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    /* Styly pro drag-and-drop zónu */
    .dropzone { 
      border: 2px dashed #cbd5e1; 
      transition: border-color 0.15s ease-in-out, background-color 0.15s ease-in-out;
    }
    .dropzone.dragover { 
      border-color: #6366f1; 
      background-color: #f5f3ff; /* Světle fialová */
    }
    /* Styly pro tabulky */
    th, td { 
      white-space: nowrap; 
      padding: 0.5rem 0.75rem; /* Více místa */
    }
    .table-wrap { 
      overflow: auto; 
      max-height: 50vh; /* Omezení výšky pro lepší přehlednost */
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    /* Styly pro grafy */
    .chart-box { 
      position: relative; 
      height: 280px; 
      /* Zajištění responzivity Chart.js */
    }
    .chart-box canvas { 
      width: 100% !important; 
      height: 100% !important; 
    }
    /* Sticky header pro tabulky */
    .table-wrap thead th {
      position: sticky;
      top: 0;
      z-index: 10; /* Vyšší z-index pro překrytí */
      background: #f9fafb; /* Světlejší pozadí */
      border-bottom: 1px solid #e5e7eb;
    }

    /* Tiskové styly pro export do PDF */
    @media print {
      body { 
        background-color: #fff; 
        color: #000;
      }
      .no-print { 
        display: none !important; 
      }
      .page-break { 
        page-break-before: always; 
      }
      /* Grafy a tabulky na šířku */
      .chart-container, .table-wrap {
        width: 100%;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8 text-gray-800">

  <header class="mb-8 pb-4 border-b border-gray-200 no-print">
    <h1 class="text-3xl font-bold text-indigo-700">Analýza aktivit strojů</h1>
    <p class="text-lg text-gray-500">Nahrávání a vizualizace dat o využití strojů</p>
  </header>

  <main class="max-w-7xl mx-auto">
    
    <!-- Sekce pro nahrávání souboru -->
    <section id="uploadSection" class="mb-10 p-6 bg-white rounded-xl shadow-lg no-print">
      <h2 id="uploadTitle" class="text-xl font-semibold mb-4 text-gray-700">Nahrát datový soubor (CSV/XLSX)</h2>
      <div id="dropzone" class="dropzone p-8 text-center rounded-lg cursor-pointer bg-gray-50 transition duration-150 ease-in-out">
        <p id="dropzoneText" class="text-gray-500">Přetáhněte soubor sem, nebo klikněte pro výběr</p>
        <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx, .xls" />
      </div>
      <p id="errorMsg" class="text-red-500 mt-2 hidden"></p>
    </section>

    <!-- Zobrazení ovládacích prvků, pokud jsou data nahrána -->
    <div id="controls" class="hidden no-print">
      <div class="flex flex-wrap items-center justify-between mb-6 p-4 bg-white rounded-xl shadow-lg">
        <div class="flex items-center space-x-4">
          <label for="langSwitch" class="text-gray-700 font-medium" id="langLabel">Jazyk:</label>
          <select id="langSwitch" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <option value="cs">Čeština</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="flex flex-wrap space-x-2 mt-4 md:mt-0">
          <button id="exportAnomBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
            Exportovat Anomálie (CSV)
          </button>
          <button id="exportSummBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
            Exportovat Souhrn (CSV)
          </button>
          <button id="exportWeeksBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
            Exportovat Týdenní (CSV)
          </button>
          <button id="printBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
            Tisk / Export PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Sekce s výsledky -->
    <div id="resultsSection" class="hidden">
      
      <!-- Souhrnná data -->
      <section class="mb-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 id="summaryTitle" class="text-2xl font-semibold mb-4 text-indigo-700">Souhrn aktivit</h2>
        <div id="summaryTable" class="table-wrap">
          <!-- Zde se dynamicky vloží tabulka Souhrnných dat -->
        </div>
      </section>

      <!-- Týdenní data - Graf a Tabulka -->
      <section class="mb-10 p-6 bg-white rounded-xl shadow-lg page-break">
        <h2 id="weeklyTitle" class="text-2xl font-semibold mb-4 text-indigo-700">Týdenní aktivita</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="chart-container">
            <h3 id="weeklyChartTitle" class="text-xl font-medium mb-3">Graf týdenní aktivity</h3>
            <div class="chart-box">
              <canvas id="weeklyChart"></canvas>
            </div>
          </div>
          <div class="table-container">
            <h3 id="weeklyTableTitle" class="text-xl font-medium mb-3">Tabulka týdenní aktivity</h3>
            <div id="weeklyTable" class="table-wrap">
              <!-- Zde se dynamicky vloží tabulka Týdenních dat -->
            </div>
          </div>
        </div>
      </section>

      <!-- Analýza anomálií -->
      <section id="anomaliesSection" class="mb-10 p-6 bg-white rounded-xl shadow-lg page-break">
        <h2 id="anomaliesTitle" class="text-2xl font-semibold mb-4 text-indigo-700">Detekce a analýza anomálií</h2>
        <p id="anomaliesCount" class="mb-4 text-lg text-red-600 font-medium hidden">
          <!-- Zde se dynamicky vloží počet anomálií -->
        </p>
        <div id="anomaliesTable" class="table-wrap">
          <!-- Zde se dynamicky vloží tabulka anomálií -->
        </div>
        <p id="noAnomaliesMsg" class="text-gray-500 mt-4 hidden">Nebyly detekovány žádné anomálie.</p>
      </section>

      <!-- Heatmap využití (Denní/Hodinové) -->
      <section class="mb-10 p-6 bg-white rounded-xl shadow-lg page-break">
        <h2 id="heatmapTitle" class="text-2xl font-semibold mb-4 text-indigo-700">Denní/Hodinová Heatmapa využití</h2>
        <div class="chart-container">
          <div class="chart-box" style="height: 400px;">
            <canvas id="heatmapChart"></canvas>
          </div>
        </div>
      </section>
      
    </div>

  </main>

  <footer class="mt-12 pt-4 border-t border-gray-200 text-center text-sm text-gray-500">
    <p>&copy; 2024 Nástroj pro analýzu aktivit strojů</p>
  </footer>

  <script type="module">
    // Globální stav aplikace
    const state = {
      data: null, // Původní data
      summary: null, // Souhrnná data
      weekly: null, // Týdenní data
      heatmap: null, // Data pro heatmapu
      anomalies: null, // Detekované anomálie
      lang: 'cs', // Výchozí jazyk
      charts: {
        weekly: null,
        heatmap: null
      }
    };

    // Pole pro mapování anglických a českých sloupců
    const COLUMN_MAP = {
      'cs': {
        'Machine ID': 'ID Stroje',
        'Total Operating Time (h)': 'Celková doba chodu (h)',
        'Average Operating Time (h)': 'Průměrná doba chodu (h)',
        'Max Operating Time (h)': 'Max. doba chodu (h)',
        'Min Operating Time (h)': 'Min. doba chodu (h)',
        'Total Downtime (h)': 'Celková doba nečinnosti (h)',
        'Utilization (%)': 'Využití (%)',
        'Week Start': 'Začátek Týdne',
        'Operating Time (h)': 'Doba Chodu (h)',
        'DayOfWeek': 'Den v Týdnu',
        'Hour': 'Hodina',
        'Value': 'Hodnota',
        'Date': 'Datum',
        'Anomaly Score': 'Skóre Anomálie',
        'Type': 'Typ Anomálie'
      },
      'en': {
        'ID Stroje': 'Machine ID',
        'Celková doba chodu (h)': 'Total Operating Time (h)',
        'Průměrná doba chodu (h)': 'Average Operating Time (h)',
        'Max. doba chodu (h)': 'Max Operating Time (h)',
        'Min. doba chodu (h)': 'Min Operating Time (h)',
        'Celková doba nečinnosti (h)': 'Total Downtime (h)',
        'Využití (%)': 'Utilization (%)',
        'Začátek Týdne': 'Week Start',
        'Doba Chodu (h)': 'Operating Time (h)',
        'Den v Týdnu': 'DayOfWeek',
        'Hodina': 'Hour',
        'Hodnota': 'Value',
        'Datum': 'Date',
        'Skóre Anomálie': 'Anomaly Score',
        'Typ Anomálie': 'Type'
      }
    };

    // Pole pro názvy dnů v týdnu pro heatmapu
    const DAY_NAMES = {
      'cs': ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'],
      'en': ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
    };

    // Objekt pro lokalizaci textů
    const localization = {
      'cs': {
        uploadTitle: 'Nahrát datový soubor (CSV/XLSX)',
        dropzoneText: 'Přetáhněte soubor sem, nebo klikněte pro výběr',
        langLabel: 'Jazyk:',
        summaryTitle: 'Souhrn aktivit',
        weeklyTitle: 'Týdenní aktivita',
        weeklyChartTitle: 'Graf týdenní aktivity',
        weeklyTableTitle: 'Tabulka týdenní aktivity',
        anomaliesTitle: 'Detekce a analýza anomálií',
        noAnomaliesMsg: 'Nebyly detekovány žádné anomálie.',
        heatmapTitle: 'Denní/Hodinová Heatmapa využití',
        noData: 'Chyba: Nebyla nalezena data.',
        invalidFormat: 'Chyba: Neplatný formát souboru nebo chybějící sloupce (očekáván: ID Stroje, Datum, Doba Chodu (h)).',
        exportAnom: 'Exportovat Anomálie (CSV)',
        exportSumm: 'Exportovat Souhrn (CSV)',
        exportWeeks: 'Exportovat Týdenní (CSV)',
        print: 'Tisk / Export PDF',
        noAnomaliesAlert: 'Žádné anomálie',
        noWeeklyAlert: 'Žádná týdenní data',
        loading: 'Načítání dat...',
        processing: 'Zpracování dat a analýza...',
        anomaliesCountText: (count) => `Detekováno ${count} anomálií. Doporučujeme kontrolu.`,
        days: DAY_NAMES['cs']
      },
      'en': {
        uploadTitle: 'Upload Data File (CSV/XLSX)',
        dropzoneText: 'Drag and drop file here, or click to select',
        langLabel: 'Language:',
        summaryTitle: 'Activity Summary',
        weeklyTitle: 'Weekly Activity',
        weeklyChartTitle: 'Weekly Activity Chart',
        weeklyTableTitle: 'Weekly Activity Table',
        anomaliesTitle: 'Anomaly Detection and Analysis',
        noAnomaliesMsg: 'No anomalies detected.',
        heatmapTitle: 'Day/Hour Utilization Heatmap',
        noData: 'Error: No data found.',
        invalidFormat: 'Error: Invalid file format or missing columns (Expected: Machine ID, Date, Operating Time (h)).',
        exportAnom: 'Export Anomalies (CSV)',
        exportSumm: 'Export Summary (CSV)',
        exportWeeks: 'Export Weekly (CSV)',
        print: 'Print / Export PDF',
        noAnomaliesAlert: 'No anomalies',
        noWeeklyAlert: 'No weekly data',
        loading: 'Loading data...',
        processing: 'Processing data and analysis...',
        anomaliesCountText: (count) => `Detected ${count} anomalies. Review recommended.`,
        days: DAY_NAMES['en']
      }
    };

    // ---- Funkce pro manipulaci s DOM a lokalizaci ----

    // Funkce pro zobrazení/skrytí chybové zprávy
    function displayError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('controls').classList.add('hidden');
    }

    // Funkce pro lokalizaci prvků na stránce
    function updateLocalization() {
      const texts = localization[state.lang];
      document.getElementById('uploadTitle').textContent = texts.uploadTitle;
      document.getElementById('dropzoneText').textContent = texts.dropzoneText;
      document.getElementById('langLabel').textContent = texts.langLabel;
      document.getElementById('summaryTitle').textContent = texts.summaryTitle;
      document.getElementById('weeklyTitle').textContent = texts.weeklyTitle;
      document.getElementById('weeklyChartTitle').textContent = texts.weeklyChartTitle;
      document.getElementById('weeklyTableTitle').textContent = texts.weeklyTableTitle;
      document.getElementById('anomaliesTitle').textContent = texts.anomaliesTitle;
      document.getElementById('noAnomaliesMsg').textContent = texts.noAnomaliesMsg;
      document.getElementById('heatmapTitle').textContent = texts.heatmapTitle;

      document.getElementById('exportAnomBtn').textContent = texts.exportAnom;
      document.getElementById('exportSummBtn').textContent = texts.exportSumm;
      document.getElementById('exportWeeksBtn').textContent = texts.exportWeeks;
      document.getElementById('printBtn').textContent = texts.print;

      // Aktualizace tabulek a grafů
      if (state.summary) {
        displaySummaryTable(state.summary);
      }
      if (state.weekly) {
        displayWeeklyTable(state.weekly);
        updateWeeklyChart(state.weekly);
      }
      if (state.heatmap) {
        updateHeatmapChart(state.heatmap);
      }
      if (state.anomalies) {
        displayAnomaliesTable(state.anomalies);
        const countMsg = document.getElementById('anomaliesCount');
        if (state.anomalies.length > 0) {
          countMsg.textContent = texts.anomaliesCountText(state.anomalies.length);
          countMsg.classList.remove('hidden');
          document.getElementById('noAnomaliesMsg').classList.add('hidden');
        } else {
          countMsg.classList.add('hidden');
          document.getElementById('noAnomaliesMsg').classList.remove('hidden');
        }
      }
    }

    // ---- Funkce pro čtení souboru ----

    // Funkce pro čtení nahraného souboru
    function handleFile(file) {
      document.getElementById('errorMsg').classList.add('hidden');
      document.getElementById('dropzoneText').textContent = localization[state.lang].loading;
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('controls').classList.add('hidden');

      const reader = new FileReader();

      reader.onload = function(e) {
        const data = e.target.result;
        let workbook;

        try {
          if (file.name.endsWith('.csv')) {
            // Čtení CSV
            workbook = XLSX.read(data, { type: 'string', raw: true });
          } else {
            // Čtení XLSX
            workbook = XLSX.read(data, { type: 'binary' });
          }

          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (json.length > 1) {
            const header = json[0];
            const rows = json.slice(1);

            // Kontrola povinných sloupců
            const requiredColumns = ['ID Stroje', 'Datum', 'Doba Chodu (h)'];
            const columnIndices = {};
            requiredColumns.forEach(col => {
              const index = header.findIndex(h => h.trim() === col);
              if (index === -1) {
                // Zkusíme anglické názvy pro případ, že soubor je v EN
                const enIndex = header.findIndex(h => h.trim() === COLUMN_MAP['en'][col]);
                if (enIndex !== -1) {
                   columnIndices[col] = enIndex;
                } else {
                   throw new Error(localization[state.lang].invalidFormat);
                }
              } else {
                columnIndices[col] = index;
              }
            });

            // Převedení dat do standardního formátu a čištění
            const processedData = rows.map(row => {
              const machineID = row[columnIndices['ID Stroje']]?.toString().trim();
              const dateRaw = row[columnIndices['Datum']];
              const operatingTimeRaw = row[columnIndices['Doba Chodu (h)']];

              // Převedení datumu na objekt Date a doby chodu na číslo
              let date;
              if (typeof dateRaw === 'number') {
                // Pravděpodobně XLSX datum, přepočet
                date = new Date(Math.round((dateRaw - 25569) * 86400 * 1000));
              } else {
                // String datum
                date = new Date(dateRaw);
              }
              
              // Zajištění, že datum je platné
              if (isNaN(date.getTime())) {
                // Může se jednat o formát DD.MM.YYYY, zkusíme prohodit
                const parts = dateRaw.split(/[\./-]/);
                if (parts.length === 3) {
                    date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                }
                if (isNaN(date.getTime())) {
                    console.warn("Invalid date format detected and skipped:", dateRaw);
                    return null; // Přeskočit neplatné záznamy
                }
              }

              // Normalizace data na GMT, aby se předešlo posunu o den
              const normalizedDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
              
              const operatingTime = parseFloat(operatingTimeRaw?.toString().replace(',', '.') || 0);

              // Data pro heatmapu
              const dayOfWeek = normalizedDate.getDay() === 0 ? 6 : normalizedDate.getDay() - 1; // 0=Po, 6=Ne
              const hour = normalizedDate.getHours();

              return {
                'ID Stroje': machineID,
                'Datum': normalizedDate.toISOString().split('T')[0], // Uložení ve formátu YYYY-MM-DD
                'Doba Chodu (h)': isNaN(operatingTime) ? 0 : operatingTime,
                'Week Start': getWeekStart(normalizedDate), // Pomocná funkce
                'DayOfWeek': dayOfWeek, // 0-6 (Po-Ne)
                'Hour': hour // 0-23
              };
            }).filter(item => item !== null && item['ID Stroje'] && item['Doba Chodu (h)'] >= 0);

            if (processedData.length === 0) {
              throw new Error(localization[state.lang].noData);
            }

            // Úspěšné načtení dat
            state.data = processedData;
            document.getElementById('dropzoneText').textContent = localization[state.lang].processing;
            
            // Spuštění analýzy
            analyzeData(processedData);

          } else {
            throw new Error(localization[state.lang].noData);
          }
        } catch (error) {
          console.error("Error processing file:", error);
          displayError(error.message);
          document.getElementById('dropzoneText').textContent = localization[state.lang].dropzoneText; // Reset text
        }
      };

      if (file.name.endsWith('.csv')) {
        reader.readAsText(file); // Čtení jako text pro CSV
      } else {
        reader.readAsBinaryString(file); // Čtení jako binární pro XLSX
      }
    }

    // ---- Funkce pro analýzu dat ----

    function getWeekStart(date) {
      const d = new Date(date);
      // Nastavení na pondělí aktuálního týdne (ISO standard)
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Upraveno pro pondělí jako 1
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().split('T')[0];
    }

    function analyzeData(data) {
      // 1. Souhrnná data (Summary)
      const summaryMap = {};
      const weeklyMap = {}; // Pro týdenní souhrn
      const heatmapMap = {}; // Pro heatmapu (Day/Hour)

      data.forEach(row => {
        const machineId = row['ID Stroje'];
        const opTime = row['Doba Chodu (h)'];
        const weekStart = row['Week Start'];
        const dayOfWeek = row['DayOfWeek'];
        const hour = row['Hour'];

        // Summary
        if (!summaryMap[machineId]) {
          summaryMap[machineId] = {
            'ID Stroje': machineId,
            'Total Operating Time (h)': 0,
            'Dates': new Set(),
            'Max Operating Time (h)': opTime,
            'Min Operating Time (h)': opTime,
            'Total Possible Days': 0 // Zatím nepoužito, pro Utilization
          };
        }
        summaryMap[machineId]['Total Operating Time (h)'] += opTime;
        summaryMap[machineId]['Dates'].add(row['Datum']); // Unikátní dny
        if (opTime > summaryMap[machineId]['Max Operating Time (h)']) {
          summaryMap[machineId]['Max Operating Time (h)'] = opTime;
        }
        if (opTime < summaryMap[machineId]['Min Operating Time (h)']) {
          summaryMap[machineId]['Min Operating Time (h)'] = opTime;
        }

        // Weekly (Součet za týden pro každý stroj)
        const weeklyKey = `${machineId}_${weekStart}`;
        if (!weeklyMap[weeklyKey]) {
          weeklyMap[weeklyKey] = {
            'ID Stroje': machineId,
            'Week Start': weekStart,
            'Operating Time (h)': 0,
          };
        }
        weeklyMap[weeklyKey]['Operating Time (h)'] += opTime;

        // Heatmap (Součet za den/hodinu pro všechny stroje)
        const heatmapKey = `${dayOfWeek}_${hour}`;
        if (!heatmapMap[heatmapKey]) {
          heatmapMap[heatmapKey] = {
            'DayOfWeek': dayOfWeek,
            'Hour': hour,
            'Total Op Time (h)': 0,
            'Count': 0
          };
        }
        heatmapMap[heatmapKey]['Total Op Time (h)'] += opTime;
        heatmapMap[heatmapKey]['Count'] += 1; // Počet záznamů
      });

      // Dokončení Souhrnných dat
      const summary = Object.values(summaryMap).map(item => {
        const totalDays = item.Dates.size;
        const totalOpTime = item['Total Operating Time (h)'];
        const avgOpTime = totalOpTime / totalDays;
        
        // Předpokládáme, že max. teoretický čas je 24 hodin * počet unikátních dní
        const totalPossibleTime = totalDays * 24; 
        const utilization = (totalOpTime / totalPossibleTime) * 100;

        return {
          'ID Stroje': item['ID Stroje'],
          'Total Operating Time (h)': parseFloat(totalOpTime.toFixed(2)),
          'Average Operating Time (h)': parseFloat(avgOpTime.toFixed(2)),
          'Max Operating Time (h)': parseFloat(item['Max Operating Time (h)'].toFixed(2)),
          'Min Operating Time (h)': parseFloat(item['Min Operating Time (h)'].toFixed(2)),
          'Total Downtime (h)': parseFloat((totalPossibleTime - totalOpTime).toFixed(2)),
          'Utilization (%)': parseFloat(utilization.toFixed(2))
        };
      }).sort((a, b) => a['ID Stroje'].localeCompare(b['ID Stroje']));

      // Týdenní data (seřazená)
      const weekly = Object.values(weeklyMap).map(item => ({
        'ID Stroje': item['ID Stroje'],
        'Week Start': item['Week Start'],
        'Operating Time (h)': parseFloat(item['Operating Time (h)'].toFixed(2))
      })).sort((a, b) => {
        if (a['Week Start'] !== b['Week Start']) {
          return new Date(a['Week Start']) - new Date(b['Week Start']);
        }
        return a['ID Stroje'].localeCompare(b['ID Stroje']);
      });

      // Heatmap data (průměrná hodnota pro buňku)
      const heatmap = Object.values(heatmapMap).map(item => ({
        'DayOfWeek': item['DayOfWeek'],
        'Hour': item['Hour'],
        // Průměrná doba chodu za danou hodinu a den v týdnu
        'Value': parseFloat((item['Total Op Time (h)'] / item['Count']).toFixed(2))
      }));

      // 2. Detekce anomálií (Z-Score)
      const anomalies = detectAnomalies(data);

      // Uložení do stavu a vykreslení
      state.summary = summary;
      state.weekly = weekly;
      state.heatmap = heatmap;
      state.anomalies = anomalies;

      document.getElementById('dropzoneText').textContent = localization[state.lang].dropzoneText; // Reset text
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('controls').classList.remove('hidden');
      
      // Vykreslení
      updateLocalization(); // Vyvolá vykreslení všech komponent s novými daty a aktuálním jazykem
    }

    // Funkce pro detekci anomálií (jednoduchá Z-Score metoda)
    function detectAnomalies(data, threshold = 2.5) {
      if (!data || data.length === 0) return [];

      // 1. Vypočítáme průměr a směrodatnou odchylku pro Doba Chodu (h)
      const opTimes = data.map(d => d['Doba Chodu (h)']);
      const mean = opTimes.reduce((sum, val) => sum + val, 0) / opTimes.length;
      const squaredDifferences = opTimes.map(val => (val - mean) ** 2);
      const variance = squaredDifferences.reduce((sum, val) => sum + val, 0) / opTimes.length;
      const stdDev = Math.sqrt(variance);

      if (stdDev === 0) return []; // Nelze detekovat anomálie, pokud jsou všechny hodnoty stejné

      // 2. Vypočítáme Z-Score a detekujeme anomálie
      const anomalies = [];
      data.forEach((row, index) => {
        const opTime = row['Doba Chodu (h)'];
        const zScore = (opTime - mean) / stdDev;
        const absZScore = Math.abs(zScore);

        if (absZScore > threshold) {
          const type = zScore > 0 ? 'Přehnané Využití' : 'Nízké Využití';
          const typeEn = zScore > 0 ? 'Over-Utilization' : 'Under-Utilization';

          anomalies.push({
            'ID Stroje': row['ID Stroje'],
            'Datum': row['Datum'],
            'Operating Time (h)': opTime,
            'Anomaly Score': parseFloat(absZScore.toFixed(2)),
            'Type': state.lang === 'cs' ? type : typeEn
          });
        }
      });

      return anomalies.sort((a, b) => b['Anomaly Score'] - a['Anomaly Score']);
    }


    // ---- Funkce pro vykreslení tabulek ----

    function createTable(data, elementId) {
      const texts = localization[state.lang];
      const container = document.getElementById(elementId);
      container.innerHTML = ''; // Vyčištění

      if (!data || data.length === 0) {
        container.innerHTML = `<p class="p-4 text-gray-500">${elementId === 'anomaliesTable' ? texts.noAnomaliesMsg : texts.noData}</p>`;
        return;
      }

      const keys = Object.keys(data[0]).filter(k => k !== 'Dates'); // Sloupce, které chceme zobrazit
      
      const table = document.createElement('table');
      table.className = 'min-w-full divide-y divide-gray-200';
      
      // Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      keys.forEach(key => {
        const th = document.createElement('th');
        // Překlad hlavičky
        th.textContent = COLUMN_MAP[state.lang][key] || key; 
        th.className = 'px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-left bg-gray-50';
        headerRow.appendChild(th);
      });
      
      // Body
      const tbody = table.createTBody();
      tbody.className = 'bg-white divide-y divide-gray-200';
      
      data.forEach(item => {
        const row = tbody.insertRow();
        keys.forEach(key => {
          const cell = row.insertCell();
          cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
          let value = item[key];

          // Formátování pro procenta
          if (key === 'Utilization (%)') {
            value = `${value}%`;
          }

          // Barvení anomálií
          if (elementId === 'anomaliesTable' && key === 'Type') {
            const colorClass = value.includes(state.lang === 'cs' ? 'Nízké' : 'Under') ? 'text-blue-600' : 'text-red-600';
            cell.innerHTML = `<span class="font-semibold ${colorClass}">${value}</span>`;
          } else if (elementId === 'anomaliesTable' && key === 'Operating Time (h)') {
             cell.innerHTML = `<span class="font-bold text-gray-900">${value}</span>`;
          } else {
             cell.textContent = value;
          }
        });
      });
      
      container.appendChild(table);
    }
    
    function displaySummaryTable(data) {
      createTable(data, 'summaryTable');
    }

    function displayWeeklyTable(data) {
      createTable(data, 'weeklyTable');
    }

    function displayAnomaliesTable(data) {
      const countMsg = document.getElementById('anomaliesCount');
      if (data.length > 0) {
        countMsg.textContent = localization[state.lang].anomaliesCountText(data.length);
        countMsg.classList.remove('hidden');
        document.getElementById('noAnomaliesMsg').classList.add('hidden');
      } else {
        countMsg.classList.add('hidden');
        document.getElementById('noAnomaliesMsg').classList.remove('hidden');
      }
      
      createTable(data, 'anomaliesTable');
    }


    // ---- Funkce pro vykreslení grafů (Chart.js) ----

    function renderWeeklyChart(data) {
      const texts = localization[state.lang];
      const ctx = document.getElementById('weeklyChart').getContext('2d');
      
      // Získání unikátních strojů a týdnů
      const machineIds = [...new Set(data.map(d => d['ID Stroje']))].sort();
      const weekStarts = [...new Set(data.map(d => d['Week Start']))].sort();

      const datasets = machineIds.map((machineId, index) => {
        const machineData = weekStarts.map(week => {
          const item = data.find(d => d['ID Stroje'] === machineId && d['Week Start'] === week);
          return item ? item['Operating Time (h)'] : 0;
        });

        // Náhodná barva pro každý stroj
        const hue = (index * 137.5) % 360; // Zlatý řez pro rozložení barev
        const color = `hsl(${hue}, 70%, 50%)`;

        return {
          label: machineId,
          data: machineData,
          borderColor: color,
          backgroundColor: color + '40', // Lehce průhledná
          tension: 0.3,
          fill: false,
          pointRadius: 3
        };
      });

      if (state.charts.weekly) {
        state.charts.weekly.destroy();
      }

      state.charts.weekly = new Chart(ctx, {
        type: 'line',
        data: {
          labels: weekStarts,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: texts.weeklyChartTitle,
              font: { size: 16 }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.y} ${state.lang === 'cs' ? 'h' : 'h'}`;
                    }
                }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: COLUMN_MAP[state.lang]['Week Start']
              }
            },
            y: {
              title: {
                display: true,
                text: COLUMN_MAP[state.lang]['Operating Time (h)']
              },
              beginAtZero: true
            }
          }
        }
      });
    }
    
    function updateWeeklyChart(data) {
        if (state.charts.weekly) {
            state.charts.weekly.destroy();
        }
        renderWeeklyChart(data);
    }
    
    function renderHeatmapChart(data) {
        const texts = localization[state.lang];
        const ctx = document.getElementById('heatmapChart').getContext('2d');
        
        // Data pro Chart.js Matrix (Heatmap)
        // Očekává se pole { x: hour, y: dayOfWeek, v: value }
        const chartData = data.map(d => ({
            x: d['Hour'],
            y: d['DayOfWeek'],
            v: d['Value']
        }));
        
        // Získání rozsahu hodnot pro barvy
        const values = chartData.map(d => d.v);
        const maxVal = Math.max(...values);
        
        if (state.charts.heatmap) {
            state.charts.heatmap.destroy();
        }

        state.charts.heatmap = new Chart(ctx, {
            type: 'matrix',
            data: {
                datasets: [{
                    label: COLUMN_MAP[state.lang]['Operating Time (h)'],
                    data: chartData,
                    backgroundColor: function(context) {
                        const value = context.dataset.data[context.dataIndex].v;
                        const ratio = value / maxVal;
                        // Barva od světle modré po tmavě modrou podle hodnoty (0.0 až 1.0)
                        const hue = 240; 
                        const saturation = 80; 
                        const lightness = 95 - (ratio * 40); // 95 (světlá) až 55 (tmavá)
                        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    },
                    borderColor: 'rgba(0,0,0,0.1)',
                    borderWidth: 1,
                    width: function(context) {
                        const a = context.chart.canvas.width;
                        const b = context.chart.canvas.height;
                        return Math.min(a, b) / 24 - 1; // Šířka buňky = (šířka/24) - okraj
                    },
                    height: function(context) {
                        const a = context.chart.canvas.width;
                        const b = context.chart.canvas.height;
                        return Math.min(a, b) / 7 - 1; // Výška buňky = (výška/7) - okraj
                    },
                    hoverBackgroundColor: 'yellow',
                    tooltipLabel: function(context) {
                        const d = context.dataset.data[context.dataIndex];
                        return `${texts.days[d.y]} ${d.x}:00 - ${d.v} h`;
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: texts.heatmapTitle,
                        font: { size: 16 }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function() { return ''; },
                            label: function(context) {
                                const d = context.dataset.data[context.dataIndex];
                                return `${texts.days[d.y]} ${d.x}:00: ${d.v} ${state.lang === 'cs' ? 'h' : 'h'}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        offset: true,
                        grid: { display: false },
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value % 2 === 0 ? value : ''; // Zobrazit každou druhou hodinu
                            }
                        },
                        title: {
                            display: true,
                            text: COLUMN_MAP[state.lang]['Hour']
                        }
                    },
                    y: {
                        type: 'category',
                        labels: texts.days,
                        offset: true,
                        grid: { display: false },
                        title: {
                            display: true,
                            text: COLUMN_MAP[state.lang]['DayOfWeek']
                        }
                    }
                }
            }
        });
    }
    
    function updateHeatmapChart(data) {
        if (state.charts.heatmap) {
            state.charts.heatmap.destroy();
        }
        renderHeatmapChart(data);
    }


    // ---- Funkce pro export do CSV ----

    // Převod pole objektů na CSV řetězec
    function arrayToCsv(data, columnMapping) {
      if (!data || data.length === 0) return null;

      // Získání hlaviček a jejich překlad
      const keys = Object.keys(data[0]).filter(k => k !== 'Dates');
      const header = keys.map(key => columnMapping[key] || key).join(';');
      
      // Řádky
      const rows = data.map(item => 
        keys.map(key => {
          let value = item[key];
          if (typeof value === 'string' && value.includes(';')) {
            value = `"${value}"`; // Ošetření středníků
          }
          return value;
        }).join(';')
      );

      return [header, ...rows].join('\n');
    }

    // Export pro Souhrn
    function toCsvSummary(data) {
      const mapping = COLUMN_MAP[state.lang];
      return arrayToCsv(data, mapping);
    }

    // Export pro Týdenní data
    function toCsvWeeks(data) {
      const mapping = COLUMN_MAP[state.lang];
      return arrayToCsv(data, mapping);
    }

    // Export pro Anomálie
    function toCsvAnomalies(data) {
      // Anomálie mají jinou sadu klíčů a jejich mapování
      const mapping = {
        'ID Stroje': COLUMN_MAP[state.lang]['Machine ID'],
        'Datum': COLUMN_MAP[state.lang]['Date'],
        'Operating Time (h)': COLUMN_MAP[state.lang]['Operating Time (h)'],
        'Anomaly Score': COLUMN_MAP[state.lang]['Anomaly Score'],
        'Type': COLUMN_MAP[state.lang]['Type']
      };
      
      // Musíme předělat data, aby obsahovala pouze potřebné klíče
      const formattedData = data.map(d => ({
        'ID Stroje': d['ID Stroje'],
        'Datum': d['Datum'],
        'Operating Time (h)': d['Operating Time (h)'],
        'Anomaly Score': d['Anomaly Score'],
        'Type': d['Type']
      }));
      
      return arrayToCsv(formattedData, mapping);
    }


    // ---- Inicializace a Listenery ----

    document.addEventListener('DOMContentLoaded', () => {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const langSwitch = document.getElementById('langSwitch');

      // 1. Změna jazyka
      langSwitch.value = state.lang; // Nastavení výchozího jazyka
      langSwitch.addEventListener('change', (e) => {
        state.lang = e.target.value;
        updateLocalization();
      });

      // 2. Drag and Drop logiky
      dropzone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleFile(e.target.files[0]);
        }
      });

      // Vizuální efekty pro Drag and Drop
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0]);
        }
      });

      // 3. Exportní tlačítka
      
      // Export Souhrnu
      document.getElementById("exportSummBtn").addEventListener("click", ()=>{
        const texts = localization[state.lang];
        const csv = toCsvSummary(state.summary||[]);
        if(!csv){ alert(texts.noData); return; }
        const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "machine_activity_summary.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      });

      // Export Anomálií
      const exportAnomBtn = document.getElementById("exportAnomBtn");
      if(exportAnomBtn){
        exportAnomBtn.addEventListener("click", ()=>{
          const texts = localization[state.lang];
          const csv = toCsvAnomalies(state.anomalies||[]);
          if(!csv){ 
            alert(texts.noAnomaliesAlert); 
            return; 
          }
          const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "machine_activity_anomalies.csv";
          link.click();
          URL.revokeObjectURL(link.href);
        });
      }

      // Export Týdenních dat
      const exportWeeksBtn = document.getElementById("exportWeeksBtn");
      if(exportWeeksBtn){
        exportWeeksBtn.addEventListener("click", () => {
          const texts = localization[state.lang];
          const csv = toCsvWeeks(state.weekly||[]);
          if(!csv){ 
            alert(texts.noWeeklyAlert); 
            return; 
          }
          const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "machine_activity_weekly.csv";
          link.click();
          URL.revokeObjectURL(link.href);
        });
      }

      // Tisk / Export PDF
      const printBtn = document.getElementById('printBtn');
      if(printBtn){
        printBtn.addEventListener('click', () => {
          window.print();
        });
      }

      // Spuštění inicializace lokalizace při startu pro zajištění správných textů
      updateLocalization();
    });

  </script>
</body>
</html>
